<!DOCTYPE html><html lang="zh-CN" class="h-full"> <head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>CUDA template · L1 Cached Papers</title><meta name="description" content="Only the Papers That Matter — HPC, LLM Inference, Crypto"><link rel="icon" href="/favicon.svg"><script defer src="https://code.iconify.design/iconify-icon/2.0.0/iconify-icon.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"><link rel="stylesheet" href="/_astro/_slug_.BmZYnI04.css"></head> <body class="min-h-screen bg-white text-slate-900"> <div aria-hidden class="h-0.5 bg-gradient-to-r from-teal-500 via-amber-400 to-teal-500"></div> <header class="border-b bg-white/80 backdrop-blur"> <div class="mx-auto max-w-5xl px-4 py-4 flex items-center justify-between"> <a href="/" class="font-semibold">L1 Cached Papers</a> <nav class="flex items-center gap-4 text-sm"> <a href="/archive/" class="hover:underline">Cacheline(Archive)</a> <a href="/about/" class="hover:underline">About</a> </nav> </div> </header> <!-- <main class="mx-auto max-w-5xl px-4 py-8"> --> <main class="mx-auto max-w-6xl px-4 py-8"></main> <button type="button" aria-label="Open Contents" data-toc-toggle aria-expanded="false" class="fixed left-4 bottom-6 z-50 inline-flex items-center justify-center
             size-10 rounded-full border bg-white/90 backdrop-blur shadow hover:bg-white
             text-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-300"><svg xmlns="http://www.w3.org/2000/svg" data-toc-icon class="size-5 transition-transform duration-200" viewBox="0 0 24 24" fill="none" stroke="currentColor"><!-- 默认右箭头；打开时我们给 svg 加 rotate-180 → 变左箭头 --><path d="M9 6l6 6-6 6" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="sr-only">Contents</span></button><div data-toc-overlay class="hidden fixed inset-0 z-40 bg-black/20"></div><aside data-toc-drawer class="fixed left-0 top-0 z-40 h-screen w-72 -translate-x-full transition-transform duration-200
             bg-white border-r shadow-xl overflow-y-auto"><div class="px-4 py-3 border-b flex items-center justify-between"><div class="text-xs uppercase tracking-wider text-slate-500">Contents</div><button type="button" class="text-slate-500 hover:text-slate-700" onclick="document.querySelector('[data-toc-overlay]').click()">✕</button></div><nav class="p-3"><ul class="space-y-1"><li class="pl-0"><a href="#sgemm" class="block truncate text-sm text-slate-600 hover:text-slate-900">sgemm</a></li><li class="pl-4"><a href="#sgemm-naive" class="block truncate text-sm text-slate-600 hover:text-slate-900">sgemm naive</a></li><li class="pl-4"><a href="#sgemm-cp-async--double-buffer" class="block truncate text-sm text-slate-600 hover:text-slate-900">sgemm cp async &amp; double buffer</a></li><li class="pl-0"><a href="#reduce" class="block truncate text-sm text-slate-600 hover:text-slate-900">reduce</a></li><li class="pl-4"><a href="#reduce-sum" class="block truncate text-sm text-slate-600 hover:text-slate-900">reduce sum</a></li><li class="pl-4"><a href="#reduce-max" class="block truncate text-sm text-slate-600 hover:text-slate-900">reduce max</a></li><li class="pl-0"><a href="#softmax" class="block truncate text-sm text-slate-600 hover:text-slate-900">softmax</a></li><li class="pl-4"><a href="#普通softmax" class="block truncate text-sm text-slate-600 hover:text-slate-900">普通softmax</a></li><li class="pl-4"><a href="#safe-softmax" class="block truncate text-sm text-slate-600 hover:text-slate-900">Safe softmax</a></li><li class="pl-4"><a href="#online-softmax" class="block truncate text-sm text-slate-600 hover:text-slate-900">online softmax</a></li><li class="pl-0"><a href="#sgemv" class="block truncate text-sm text-slate-600 hover:text-slate-900">sgemv</a></li><li class="pl-0"><a href="#element-wise" class="block truncate text-sm text-slate-600 hover:text-slate-900">element-wise</a></li></ul></nav></aside><script>
      // 元素
      const btn = document.querySelector('[data-toc-toggle]');
      const icon = btn?.querySelector('[data-toc-icon]');
      const drawer = document.querySelector('[data-toc-drawer]');
      const overlay = document.querySelector('[data-toc-overlay]');
      const links = drawer?.querySelectorAll('a[href^="#"]');
      const idToLink = new Map();
      links?.forEach(a => idToLink.set(a.getAttribute('href')?.slice(1), a));

      // 开关（并同步箭头方向）
      function openTOC(){
        drawer?.classList.remove('-translate-x-full');
        overlay?.classList.remove('hidden');
        btn?.setAttribute('aria-expanded','true');
        icon?.classList.add('rotate-180'); // → 变 ←
      }
      function closeTOC(){
        drawer?.classList.add('-translate-x-full');
        overlay?.classList.add('hidden');
        btn?.setAttribute('aria-expanded','false');
        icon?.classList.remove('rotate-180'); // 还原 →
      }

      btn?.addEventListener('click', () => {
        if (drawer?.classList.contains('-translate-x-full')) {
          openTOC(); 
        } 
        else closeTOC();
      });
      overlay?.addEventListener('click', closeTOC);
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeTOC(); });

      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          const id = entry.target.getAttribute('id');
          const link = id && idToLink.get(id);
          if (!link) return;
          if (entry.isIntersecting) {
            links?.forEach((l) => l.classList.remove('text-slate-900','font-medium'));
            link.classList.add('text-slate-900','font-medium');
          }
        });
      }, { rootMargin: '0px 0px -70% 0px', threshold: 0.1 });

      document.querySelectorAll('article :is(h1,h2,h3)').forEach((h) => observer.observe(h));
    </script>  <div class="mx-auto w-full max-w-5xl"> <!-- 长文阅读卡片（整块内容隔离背景） --> <div class="read-card"> <nav class="text-sm text-slate-500 mb-4" data-breadcrumb> <a class="hover:underline" href="/">首页</a> <span class="mx-1">/</span> <a class="hover:underline" href="/archive/">Cacheline(Archive)</a> </nav> <header class="not-prose mb-6 text-center"> <h1 class="text-3xl md:text-4xl font-semibold leading-tight tracking-tight !max-w-none [text-wrap:balance]"> CUDA template </h1> <div class="mt-2 flex flex-wrap items-center justify-center gap-3 text-sm text-slate-500"> <span class="inline-flex items-center">
更新于 2025/9/16  </span>   </div> </header> <article class="prose prose-slate prose-wide">  <h1 id="sgemm">sgemm<a class="anchor" href="#sgemm"><span class="icon icon-link"></span></a></h1>
<h2 id="sgemm-naive">sgemm naive<a class="anchor" href="#sgemm-naive"><span class="icon icon-link"></span></a></h2>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="cpp" data-theme="github-light"><code data-language="cpp" data-theme="github-light" style="display:grid"><span data-line><span style="color:#6A737D">// blockDim for threads: BN / TN, BM / TM</span></span>
<span data-line><span style="color:#6A737D">// gridDim for blocks: (N + BN - 1) / BN, (M + BM - 1) / BM</span></span>
<span data-line><span style="color:#D73A49">template</span><span style="color:#24292E">&lt;</span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> BM </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 128</span><span style="color:#24292E">, </span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> BN </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 128</span><span style="color:#24292E">, </span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> BK </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 8</span><span style="color:#24292E">,</span></span>
<span data-line><span style="color:#D73A49">        const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> TM </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 8</span><span style="color:#24292E">, </span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> TN </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 8</span><span style="color:#24292E">&gt;</span></span>
<span data-line><span style="color:#24292E">__global__ </span><span style="color:#D73A49">void</span><span style="color:#6F42C1"> sgemm_f32x4_tiled_copy</span><span style="color:#24292E">(</span><span style="color:#D73A49">float*</span><span style="color:#24292E"> input_a, </span><span style="color:#D73A49">float*</span><span style="color:#24292E"> input_b, </span><span style="color:#D73A49">float*</span><span style="color:#24292E"> output,</span></span>
<span data-line><span style="color:#D73A49">                                        const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> M, </span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> N, </span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> K) {</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> tx </span><span style="color:#D73A49">=</span><span style="color:#24292E"> threadIdx.x;</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> ty </span><span style="color:#D73A49">=</span><span style="color:#24292E"> threadIdx.y;</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> bx </span><span style="color:#D73A49">=</span><span style="color:#24292E"> blockIdx.x;</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> by </span><span style="color:#D73A49">=</span><span style="color:#24292E"> blockIdx.y;</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> tid </span><span style="color:#D73A49">=</span><span style="color:#24292E"> blockDim.x </span><span style="color:#D73A49">*</span><span style="color:#24292E"> ty </span><span style="color:#D73A49">+</span><span style="color:#24292E"> tx;</span></span>
<span data-line> </span>
<span data-line><span style="color:#24292E">    __shared__ </span><span style="color:#D73A49">float</span><span style="color:#24292E"> s_a[BM][BK], s_b[BK][BN];</span><span style="color:#6A737D">  // 128 x 8 x 4 x 2 = 8KB</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">    // 首先计算shared mem的index</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> smem_a_m </span><span style="color:#D73A49">=</span><span style="color:#24292E"> tid </span><span style="color:#D73A49">/</span><span style="color:#005CC5"> 2</span><span style="color:#24292E">;</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> smem_a_k </span><span style="color:#D73A49">=</span><span style="color:#24292E"> tid </span><span style="color:#D73A49">%</span><span style="color:#005CC5"> 2</span><span style="color:#D73A49"> ==</span><span style="color:#005CC5"> 0</span><span style="color:#D73A49"> ?</span><span style="color:#005CC5"> 0</span><span style="color:#D73A49"> :</span><span style="color:#005CC5"> 4</span><span style="color:#24292E">;</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> smem_b_k </span><span style="color:#D73A49">=</span><span style="color:#24292E"> tid </span><span style="color:#D73A49">/</span><span style="color:#005CC5"> 32</span><span style="color:#24292E">;</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> smem_b_n </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (tid </span><span style="color:#D73A49">%</span><span style="color:#005CC5"> 32</span><span style="color:#24292E">) </span><span style="color:#D73A49">*</span><span style="color:#005CC5"> 4</span><span style="color:#24292E">;</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> gmem_a_m </span><span style="color:#D73A49">=</span><span style="color:#24292E"> by </span><span style="color:#D73A49">*</span><span style="color:#24292E"> BM </span><span style="color:#D73A49">+</span><span style="color:#24292E"> smem_a_m;</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> gmem_b_n </span><span style="color:#D73A49">=</span><span style="color:#24292E"> bx </span><span style="color:#D73A49">*</span><span style="color:#24292E"> BN </span><span style="color:#D73A49">+</span><span style="color:#24292E"> smem_b_n;</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">    float</span><span style="color:#24292E"> reg_c[TM][TN] </span><span style="color:#D73A49">=</span><span style="color:#24292E"> {</span><span style="color:#005CC5">0.0</span><span style="color:#D73A49">f</span><span style="color:#24292E">};</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">    for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> bk </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; bk </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> (K </span><span style="color:#D73A49">+</span><span style="color:#24292E"> BK </span><span style="color:#D73A49">-</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">) </span><span style="color:#D73A49">/</span><span style="color:#24292E"> BK; bk</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#D73A49">        int</span><span style="color:#24292E"> gmem_a_k </span><span style="color:#D73A49">=</span><span style="color:#24292E"> bk </span><span style="color:#D73A49">*</span><span style="color:#24292E"> BK </span><span style="color:#D73A49">+</span><span style="color:#24292E"> smem_a_k;</span></span>
<span data-line><span style="color:#D73A49">        int</span><span style="color:#24292E"> gmem_a_addr </span><span style="color:#D73A49">=</span><span style="color:#24292E"> gmem_a_m </span><span style="color:#D73A49">*</span><span style="color:#24292E"> K </span><span style="color:#D73A49">+</span><span style="color:#24292E"> gmem_a_k;</span><span style="color:#6A737D">  // 这里是K</span></span>
<span data-line><span style="color:#6F42C1">        FLOAT4</span><span style="color:#24292E">(s_a[smem_a_m][smem_a_k]) </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> FLOAT4</span><span style="color:#24292E">(input_a[gmem_a_addr]);</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">        int</span><span style="color:#24292E"> gmem_b_k </span><span style="color:#D73A49">=</span><span style="color:#24292E"> bk </span><span style="color:#D73A49">*</span><span style="color:#24292E"> BK </span><span style="color:#D73A49">+</span><span style="color:#24292E"> smem_b_k;</span></span>
<span data-line><span style="color:#D73A49">        int</span><span style="color:#24292E"> gmem_b_addr </span><span style="color:#D73A49">=</span><span style="color:#24292E"> gmem_b_k </span><span style="color:#D73A49">*</span><span style="color:#24292E"> N </span><span style="color:#D73A49">+</span><span style="color:#24292E"> gmem_b_n;</span></span>
<span data-line><span style="color:#6F42C1">        FLOAT4</span><span style="color:#24292E">(s_b[smem_b_k][smem_b_n]) </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> FLOAT4</span><span style="color:#24292E">(input_b[gmem_b_addr]);</span></span>
<span data-line> </span>
<span data-line><span style="color:#6F42C1">        __syncthreads</span><span style="color:#24292E">();</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">        // 下面进行GEMM</span></span>
<span data-line><span style="color:#D73A49">        #pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">        for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> k </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; k </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> BK; k</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#D73A49">            #pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">            for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> m </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; m </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> TM; m</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#D73A49">                #pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">                for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> n </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; n </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> TN; n</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#D73A49">                    int</span><span style="color:#24292E"> s_m_idx </span><span style="color:#D73A49">=</span><span style="color:#24292E"> ty </span><span style="color:#D73A49">*</span><span style="color:#24292E"> TM </span><span style="color:#D73A49">+</span><span style="color:#24292E"> m;</span></span>
<span data-line><span style="color:#D73A49">                    int</span><span style="color:#24292E"> s_n_idx </span><span style="color:#D73A49">=</span><span style="color:#24292E"> tx </span><span style="color:#D73A49">*</span><span style="color:#24292E"> TN </span><span style="color:#D73A49">+</span><span style="color:#24292E"> n;</span></span>
<span data-line><span style="color:#24292E">                    reg_c[m][n] </span><span style="color:#D73A49">+=</span><span style="color:#24292E"> s_a[s_m_idx][k] </span><span style="color:#D73A49">*</span><span style="color:#24292E"> s_b[k][s_n_idx];</span></span>
<span data-line><span style="color:#24292E">                }</span></span>
<span data-line><span style="color:#24292E">            }</span></span>
<span data-line><span style="color:#24292E">        }</span></span>
<span data-line><span style="color:#6F42C1">        __syncthreads</span><span style="color:#24292E">();</span></span>
<span data-line><span style="color:#24292E">    }</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">    // store the results</span></span>
<span data-line><span style="color:#D73A49">    #pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">    for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> m </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; m </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> TM; m</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#D73A49">        int</span><span style="color:#24292E"> st_m </span><span style="color:#D73A49">=</span><span style="color:#24292E"> by </span><span style="color:#D73A49">*</span><span style="color:#24292E"> BM </span><span style="color:#D73A49">+</span><span style="color:#24292E"> ty </span><span style="color:#D73A49">*</span><span style="color:#24292E"> TM </span><span style="color:#D73A49">+</span><span style="color:#24292E"> m;</span></span>
<span data-line><span style="color:#D73A49">        #pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">        for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> n </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; n </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> TN; n</span><span style="color:#D73A49">+=</span><span style="color:#005CC5">4</span><span style="color:#24292E">) {</span><span style="color:#6A737D">  // 这里是+=4</span></span>
<span data-line><span style="color:#D73A49">            int</span><span style="color:#24292E"> st_n </span><span style="color:#D73A49">=</span><span style="color:#24292E"> bx </span><span style="color:#D73A49">*</span><span style="color:#24292E"> BN </span><span style="color:#D73A49">+</span><span style="color:#24292E"> tx </span><span style="color:#D73A49">*</span><span style="color:#24292E"> TN </span><span style="color:#D73A49">+</span><span style="color:#24292E"> n;</span><span style="color:#6A737D">   // 这里加错了一个数字</span></span>
<span data-line><span style="color:#D73A49">            int</span><span style="color:#24292E"> g_addr </span><span style="color:#D73A49">=</span><span style="color:#24292E"> st_m </span><span style="color:#D73A49">*</span><span style="color:#24292E"> N </span><span style="color:#D73A49">+</span><span style="color:#24292E"> st_n;</span></span>
<span data-line><span style="color:#6F42C1">            FLOAT4</span><span style="color:#24292E">(output[g_addr]) </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> FLOAT4</span><span style="color:#24292E">(reg_c[m][n]);</span></span>
<span data-line><span style="color:#24292E">        }</span></span>
<span data-line><span style="color:#24292E">    }</span></span>
<span data-line><span style="color:#24292E">}</span></span></code></pre></figure>
<h2 id="sgemm-cp-async--double-buffer">sgemm cp async &amp; double buffer<a class="anchor" href="#sgemm-cp-async--double-buffer"><span class="icon icon-link"></span></a></h2>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="cpp" data-theme="github-light"><code data-language="cpp" data-theme="github-light" style="display:grid"><span data-line><span style="color:#D73A49">#define</span><span style="color:#6F42C1"> LDST128BITS</span><span style="color:#24292E">(</span><span style="color:#E36209">value</span><span style="color:#24292E">) (</span><span style="color:#D73A49">reinterpret_cast&lt;</span><span style="color:#24292E">float4 </span><span style="color:#D73A49">*&gt;</span><span style="color:#24292E">(</span><span style="color:#D73A49">&amp;</span><span style="color:#24292E">(value))[</span><span style="color:#005CC5">0</span><span style="color:#24292E">])</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">#define</span><span style="color:#6F42C1"> CP_ASYNC_COMMIT_GROUP</span><span style="color:#24292E">() </span><span style="color:#D73A49">asm</span><span style="color:#D73A49"> volatile</span><span style="color:#24292E">(</span><span style="color:#032F62">&quot;</span><span style="color:#032F62">cp.async.commit_group;</span><span style="color:#005CC5">\n</span><span style="color:#032F62">&quot;</span><span style="color:#24292E"> ::)</span></span>
<span data-line><span style="color:#D73A49">#define</span><span style="color:#6F42C1"> CP_ASYNC_WAIT_ALL</span><span style="color:#24292E">() </span><span style="color:#D73A49">asm</span><span style="color:#D73A49"> volatile</span><span style="color:#24292E">(</span><span style="color:#032F62">&quot;</span><span style="color:#032F62">cp.async.wait_all;</span><span style="color:#005CC5">\n</span><span style="color:#032F62">&quot;</span><span style="color:#24292E"> ::)</span></span>
<span data-line><span style="color:#D73A49">#define</span><span style="color:#6F42C1"> CP_ASYNC_WAIT_GROUP</span><span style="color:#24292E">(</span><span style="color:#E36209">n</span><span style="color:#24292E">)                                                 </span><span style="color:#005CC5">\</span></span>
<span data-line><span style="color:#D73A49">  asm</span><span style="color:#D73A49"> volatile</span><span style="color:#24292E">(</span><span style="color:#032F62">&quot;</span><span style="color:#032F62">cp.async.wait_group %0;</span><span style="color:#005CC5">\n</span><span style="color:#032F62">&quot;</span><span style="color:#24292E"> ::</span><span style="color:#032F62">&quot;</span><span style="color:#032F62">n</span><span style="color:#032F62">&quot;</span><span style="color:#24292E">(n))</span></span>
<span data-line><span style="color:#6A737D">// ca(cache all, L1 + L2): support 4, 8, 16 bytes, cg(cache global, L2): only</span></span>
<span data-line><span style="color:#6A737D">// support 16 bytes.</span></span>
<span data-line><span style="color:#D73A49">#define</span><span style="color:#6F42C1"> CP_ASYNC_CA</span><span style="color:#24292E">(</span><span style="color:#E36209">dst</span><span style="color:#24292E">, </span><span style="color:#E36209">src</span><span style="color:#24292E">, </span><span style="color:#E36209">bytes</span><span style="color:#24292E">)                                           </span><span style="color:#005CC5">\</span></span>
<span data-line><span style="color:#D73A49">  asm</span><span style="color:#D73A49"> volatile</span><span style="color:#24292E">(                                                                \</span></span>
<span data-line><span style="color:#032F62">      &quot;</span><span style="color:#032F62">cp.async.ca.shared.global.L2::128B [%0], [%1], %2;</span><span style="color:#005CC5">\n</span><span style="color:#032F62">&quot;</span><span style="color:#24292E"> ::</span><span style="color:#032F62">&quot;</span><span style="color:#032F62">r</span><span style="color:#032F62">&quot;</span><span style="color:#24292E">(dst),       \</span></span>
<span data-line><span style="color:#032F62">      &quot;</span><span style="color:#032F62">l</span><span style="color:#032F62">&quot;</span><span style="color:#24292E">(src), </span><span style="color:#032F62">&quot;</span><span style="color:#032F62">n</span><span style="color:#032F62">&quot;</span><span style="color:#24292E">(bytes))</span></span>
<span data-line><span style="color:#D73A49">#define</span><span style="color:#6F42C1"> CP_ASYNC_CG</span><span style="color:#24292E">(</span><span style="color:#E36209">dst</span><span style="color:#24292E">, </span><span style="color:#E36209">src</span><span style="color:#24292E">, </span><span style="color:#E36209">bytes</span><span style="color:#24292E">)                                           </span><span style="color:#005CC5">\</span></span>
<span data-line><span style="color:#D73A49">  asm</span><span style="color:#D73A49"> volatile</span><span style="color:#24292E">(                                                                \</span></span>
<span data-line><span style="color:#032F62">      &quot;</span><span style="color:#032F62">cp.async.cg.shared.global.L2::128B [%0], [%1], %2;</span><span style="color:#005CC5">\n</span><span style="color:#032F62">&quot;</span><span style="color:#24292E"> ::</span><span style="color:#032F62">&quot;</span><span style="color:#032F62">r</span><span style="color:#032F62">&quot;</span><span style="color:#24292E">(dst),       \</span></span>
<span data-line><span style="color:#032F62">      &quot;</span><span style="color:#032F62">l</span><span style="color:#032F62">&quot;</span><span style="color:#24292E">(src), </span><span style="color:#032F62">&quot;</span><span style="color:#032F62">n</span><span style="color:#032F62">&quot;</span><span style="color:#24292E">(bytes))</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">template</span><span style="color:#24292E"> &lt;</span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> BM </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 64</span><span style="color:#24292E">, </span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> BN </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 64</span><span style="color:#24292E">, </span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> BK </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 16</span><span style="color:#24292E">,</span></span>
<span data-line><span style="color:#D73A49">          const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> TM </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 8</span><span style="color:#24292E">, </span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> TN </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 4</span><span style="color:#24292E">, </span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> OFFSET </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">&gt;</span></span>
<span data-line><span style="color:#24292E">__global__ </span><span style="color:#D73A49">void</span><span style="color:#6F42C1"> sgemm_t_8x4_sliced_k16_f32x4_bcf_dbuf_async_kernel</span><span style="color:#24292E">(</span></span>
<span data-line><span style="color:#D73A49">    float</span><span style="color:#D73A49"> *</span><span style="color:#24292E">a, </span><span style="color:#D73A49">float</span><span style="color:#D73A49"> *</span><span style="color:#24292E">b, </span><span style="color:#D73A49">float</span><span style="color:#D73A49"> *</span><span style="color:#24292E">c, </span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> M, </span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> N, </span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> K) {</span></span>
<span data-line><span style="color:#6A737D">  // block(BN/TN, BM/TM) -&gt; (x=16,y=8), 128 threads</span></span>
<span data-line><span style="color:#D73A49">  const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> bx </span><span style="color:#D73A49">=</span><span style="color:#24292E"> blockIdx.x;</span></span>
<span data-line><span style="color:#D73A49">  const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> by </span><span style="color:#D73A49">=</span><span style="color:#24292E"> blockIdx.y;</span></span>
<span data-line><span style="color:#D73A49">  const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> tx </span><span style="color:#D73A49">=</span><span style="color:#24292E"> threadIdx.x;</span></span>
<span data-line><span style="color:#D73A49">  const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> ty </span><span style="color:#D73A49">=</span><span style="color:#24292E"> threadIdx.y;</span></span>
<span data-line><span style="color:#D73A49">  const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> tid </span><span style="color:#D73A49">=</span><span style="color:#24292E"> ty </span><span style="color:#D73A49">*</span><span style="color:#24292E"> blockDim.x </span><span style="color:#D73A49">+</span><span style="color:#24292E"> tx;</span></span>
<span data-line><span style="color:#6A737D">  // 2*(16*64*4)=8KB, 8+8=16KB, 128KB/16=8 blocks</span></span>
<span data-line><span style="color:#24292E">  __shared__ </span><span style="color:#D73A49">float</span><span style="color:#24292E"> s_a[</span><span style="color:#005CC5">2</span><span style="color:#24292E">][BK][BM </span><span style="color:#D73A49">+</span><span style="color:#24292E"> OFFSET];</span></span>
<span data-line><span style="color:#24292E">  __shared__ </span><span style="color:#D73A49">float</span><span style="color:#24292E"> s_b[</span><span style="color:#005CC5">2</span><span style="color:#24292E">][BK][BN </span><span style="color:#D73A49">+</span><span style="color:#24292E"> OFFSET];</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">  float</span><span style="color:#24292E"> r_load_a[</span><span style="color:#005CC5">8</span><span style="color:#24292E">];</span><span style="color:#6A737D"> // load 8 values per thread</span></span>
<span data-line><span style="color:#D73A49">  float</span><span style="color:#24292E"> r_comp_a[TM];</span></span>
<span data-line><span style="color:#D73A49">  float</span><span style="color:#24292E"> r_comp_b[TN];</span></span>
<span data-line><span style="color:#D73A49">  float</span><span style="color:#24292E"> r_c[TM][TN] </span><span style="color:#D73A49">=</span><span style="color:#24292E"> {</span><span style="color:#005CC5">0.0</span><span style="color:#24292E">};</span><span style="color:#6A737D"> // 8x4</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">  // 128 threads, tx: 0~15, ty: 0~7</span></span>
<span data-line><span style="color:#D73A49">  int</span><span style="color:#24292E"> load_a_smem_m </span><span style="color:#D73A49">=</span><span style="color:#24292E"> tid </span><span style="color:#D73A49">/</span><span style="color:#005CC5"> 2</span><span style="color:#24292E">;</span><span style="color:#6A737D">                // (0,1,2,...,63)</span></span>
<span data-line><span style="color:#D73A49">  int</span><span style="color:#24292E"> load_a_smem_k </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (tid </span><span style="color:#D73A49">%</span><span style="color:#005CC5"> 2</span><span style="color:#D73A49"> ==</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">) </span><span style="color:#D73A49">?</span><span style="color:#005CC5"> 0</span><span style="color:#D73A49"> :</span><span style="color:#005CC5"> 8</span><span style="color:#24292E">;</span><span style="color:#6A737D"> // (0,8)</span></span>
<span data-line><span style="color:#D73A49">  int</span><span style="color:#24292E"> load_b_smem_k </span><span style="color:#D73A49">=</span><span style="color:#24292E"> tid </span><span style="color:#D73A49">/</span><span style="color:#005CC5"> 8</span><span style="color:#24292E">;</span><span style="color:#6A737D">                // 0~15</span></span>
<span data-line><span style="color:#D73A49">  int</span><span style="color:#24292E"> load_b_smem_n </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (tid </span><span style="color:#D73A49">%</span><span style="color:#005CC5"> 8</span><span style="color:#24292E">) </span><span style="color:#D73A49">*</span><span style="color:#005CC5"> 8</span><span style="color:#24292E">;</span><span style="color:#6A737D">          // (0,8,16,...,56)</span></span>
<span data-line><span style="color:#D73A49">  int</span><span style="color:#24292E"> load_a_gmem_m </span><span style="color:#D73A49">=</span><span style="color:#24292E"> by </span><span style="color:#D73A49">*</span><span style="color:#24292E"> BM </span><span style="color:#D73A49">+</span><span style="color:#24292E"> load_a_smem_m;</span></span>
<span data-line><span style="color:#D73A49">  int</span><span style="color:#24292E"> load_b_gmem_n </span><span style="color:#D73A49">=</span><span style="color:#24292E"> bx </span><span style="color:#D73A49">*</span><span style="color:#24292E"> BN </span><span style="color:#D73A49">+</span><span style="color:#24292E"> load_b_smem_n;</span></span>
<span data-line> </span>
<span data-line><span style="color:#24292E">  {</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> load_a_gmem_k </span><span style="color:#D73A49">=</span><span style="color:#24292E"> load_a_smem_k;</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> load_a_gmem_addr </span><span style="color:#D73A49">=</span><span style="color:#24292E"> load_a_gmem_m </span><span style="color:#D73A49">*</span><span style="color:#24292E"> K </span><span style="color:#D73A49">+</span><span style="color:#24292E"> load_a_gmem_k;</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> load_b_gmem_k </span><span style="color:#D73A49">=</span><span style="color:#24292E"> load_b_smem_k;</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> load_b_gmem_addr </span><span style="color:#D73A49">=</span><span style="color:#24292E"> load_b_gmem_k </span><span style="color:#D73A49">*</span><span style="color:#24292E"> N </span><span style="color:#D73A49">+</span><span style="color:#24292E"> load_b_gmem_n;</span></span>
<span data-line><span style="color:#D73A49">    uint32_t</span><span style="color:#24292E"> load_b_smem_ptr </span><span style="color:#D73A49">=</span></span>
<span data-line><span style="color:#6F42C1">        __cvta_generic_to_shared</span><span style="color:#24292E">(</span><span style="color:#D73A49">&amp;</span><span style="color:#24292E">s_b[</span><span style="color:#005CC5">0</span><span style="color:#24292E">][load_b_smem_k][load_b_smem_n]);</span></span>
<span data-line><span style="color:#6A737D">// 2 cp.async issue, 16 bytes = 4 float.</span></span>
<span data-line><span style="color:#D73A49">#pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">    for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> i </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; i </span><span style="color:#D73A49">&lt;</span><span style="color:#005CC5"> 8</span><span style="color:#24292E">; i </span><span style="color:#D73A49">+=</span><span style="color:#005CC5"> 4</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#6F42C1">      CP_ASYNC_CA</span><span style="color:#24292E">(load_b_smem_ptr </span><span style="color:#D73A49">+</span><span style="color:#24292E"> i </span><span style="color:#D73A49">*</span><span style="color:#005CC5"> 4</span><span style="color:#24292E">, </span><span style="color:#D73A49">&amp;</span><span style="color:#24292E">b[load_b_gmem_addr </span><span style="color:#D73A49">+</span><span style="color:#24292E"> i], </span><span style="color:#005CC5">16</span><span style="color:#24292E">);</span></span>
<span data-line><span style="color:#24292E">    }</span></span>
<span data-line><span style="color:#6F42C1">    CP_ASYNC_COMMIT_GROUP</span><span style="color:#24292E">();</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">#pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">    for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> i </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; i </span><span style="color:#D73A49">&lt;</span><span style="color:#005CC5"> 8</span><span style="color:#24292E">; i </span><span style="color:#D73A49">+=</span><span style="color:#005CC5"> 4</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#6F42C1">      FLOAT4</span><span style="color:#24292E">(r_load_a[i]) </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (</span><span style="color:#6F42C1">FLOAT4</span><span style="color:#24292E">(a[load_a_gmem_addr </span><span style="color:#D73A49">+</span><span style="color:#24292E"> i]));</span></span>
<span data-line><span style="color:#24292E">    }</span></span>
<span data-line><span style="color:#D73A49">#pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">    for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> i </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; i </span><span style="color:#D73A49">&lt;</span><span style="color:#005CC5"> 8</span><span style="color:#24292E">; </span><span style="color:#D73A49">++</span><span style="color:#24292E">i) {</span></span>
<span data-line><span style="color:#24292E">      s_a[</span><span style="color:#005CC5">0</span><span style="color:#24292E">][load_a_smem_k </span><span style="color:#D73A49">+</span><span style="color:#24292E"> i][load_a_smem_m] </span><span style="color:#D73A49">=</span><span style="color:#24292E"> r_load_a[i];</span></span>
<span data-line><span style="color:#24292E">    }</span></span>
<span data-line><span style="color:#6F42C1">    CP_ASYNC_WAIT_GROUP</span><span style="color:#24292E">(</span><span style="color:#005CC5">0</span><span style="color:#24292E">);</span></span>
<span data-line><span style="color:#24292E">  }</span></span>
<span data-line><span style="color:#6F42C1">  __syncthreads</span><span style="color:#24292E">();</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">  for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> bk </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">; bk </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> (K </span><span style="color:#D73A49">+</span><span style="color:#24292E"> BK </span><span style="color:#D73A49">-</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">) </span><span style="color:#D73A49">/</span><span style="color:#24292E"> BK; bk</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> smem_sel </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (bk </span><span style="color:#D73A49">-</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">) </span><span style="color:#D73A49">&amp;</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">;</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> smem_sel_next </span><span style="color:#D73A49">=</span><span style="color:#24292E"> bk </span><span style="color:#D73A49">&amp;</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">;</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> load_a_gmem_k </span><span style="color:#D73A49">=</span><span style="color:#24292E"> bk </span><span style="color:#D73A49">*</span><span style="color:#24292E"> BK </span><span style="color:#D73A49">+</span><span style="color:#24292E"> load_a_smem_k;</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> load_a_gmem_addr </span><span style="color:#D73A49">=</span><span style="color:#24292E"> load_a_gmem_m </span><span style="color:#D73A49">*</span><span style="color:#24292E"> K </span><span style="color:#D73A49">+</span><span style="color:#24292E"> load_a_gmem_k;</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> load_b_gmem_k </span><span style="color:#D73A49">=</span><span style="color:#24292E"> bk </span><span style="color:#D73A49">*</span><span style="color:#24292E"> BK </span><span style="color:#D73A49">+</span><span style="color:#24292E"> load_b_smem_k;</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> load_b_gmem_addr </span><span style="color:#D73A49">=</span><span style="color:#24292E"> load_b_gmem_k </span><span style="color:#D73A49">*</span><span style="color:#24292E"> N </span><span style="color:#D73A49">+</span><span style="color:#24292E"> load_b_gmem_n;</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">    uint32_t</span><span style="color:#24292E"> load_b_smem_ptr </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> __cvta_generic_to_shared</span><span style="color:#24292E">(</span></span>
<span data-line><span style="color:#D73A49">        &amp;</span><span style="color:#24292E">s_b[smem_sel_next][load_b_smem_k][load_b_smem_n]);</span></span>
<span data-line><span style="color:#6A737D">// 2 cp.async issue, 16 bytes = 4 float.</span></span>
<span data-line><span style="color:#D73A49">#pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">    for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> i </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; i </span><span style="color:#D73A49">&lt;</span><span style="color:#005CC5"> 8</span><span style="color:#24292E">; i </span><span style="color:#D73A49">+=</span><span style="color:#005CC5"> 4</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#6F42C1">      CP_ASYNC_CA</span><span style="color:#24292E">(load_b_smem_ptr </span><span style="color:#D73A49">+</span><span style="color:#24292E"> i </span><span style="color:#D73A49">*</span><span style="color:#005CC5"> 4</span><span style="color:#24292E">, </span><span style="color:#D73A49">&amp;</span><span style="color:#24292E">b[load_b_gmem_addr </span><span style="color:#D73A49">+</span><span style="color:#24292E"> i], </span><span style="color:#005CC5">16</span><span style="color:#24292E">);</span></span>
<span data-line><span style="color:#24292E">    }</span></span>
<span data-line><span style="color:#6F42C1">    CP_ASYNC_COMMIT_GROUP</span><span style="color:#24292E">();</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">#pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">    for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> i </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; i </span><span style="color:#D73A49">&lt;</span><span style="color:#005CC5"> 8</span><span style="color:#24292E">; i </span><span style="color:#D73A49">+=</span><span style="color:#005CC5"> 4</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#6F42C1">      FLOAT4</span><span style="color:#24292E">(r_load_a[i]) </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (</span><span style="color:#6F42C1">FLOAT4</span><span style="color:#24292E">(a[load_a_gmem_addr </span><span style="color:#D73A49">+</span><span style="color:#24292E"> i]));</span></span>
<span data-line><span style="color:#24292E">    }</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">#pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">    for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> tk </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; tk </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> BK; tk</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#6F42C1">      FLOAT4</span><span style="color:#24292E">(r_comp_a[</span><span style="color:#005CC5">0</span><span style="color:#24292E">]) </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> FLOAT4</span><span style="color:#24292E">(s_a[smem_sel][tk][ty </span><span style="color:#D73A49">*</span><span style="color:#24292E"> TM]);</span></span>
<span data-line><span style="color:#6F42C1">      FLOAT4</span><span style="color:#24292E">(r_comp_a[</span><span style="color:#005CC5">4</span><span style="color:#24292E">]) </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> FLOAT4</span><span style="color:#24292E">(s_a[smem_sel][tk][ty </span><span style="color:#D73A49">*</span><span style="color:#24292E"> TM </span><span style="color:#D73A49">+</span><span style="color:#005CC5"> 4</span><span style="color:#24292E">]);</span></span>
<span data-line><span style="color:#6F42C1">      FLOAT4</span><span style="color:#24292E">(r_comp_b[</span><span style="color:#005CC5">0</span><span style="color:#24292E">]) </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> FLOAT4</span><span style="color:#24292E">(s_b[smem_sel][tk][tx </span><span style="color:#D73A49">*</span><span style="color:#24292E"> TN]);</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">#pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">      for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> tm </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; tm </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> TM; tm</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#D73A49">#pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">        for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> tn </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; tn </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> TN; tn</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#24292E">          r_c[tm][tn] </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> __fmaf_rn</span><span style="color:#24292E">(r_comp_a[tm], r_comp_b[tn], r_c[tm][tn]);</span></span>
<span data-line><span style="color:#24292E">        }</span></span>
<span data-line><span style="color:#24292E">      }</span></span>
<span data-line><span style="color:#24292E">    }</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">#pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">    for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> i </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; i </span><span style="color:#D73A49">&lt;</span><span style="color:#005CC5"> 8</span><span style="color:#24292E">; </span><span style="color:#D73A49">++</span><span style="color:#24292E">i) {</span></span>
<span data-line><span style="color:#24292E">      s_a[smem_sel_next][load_a_smem_k </span><span style="color:#D73A49">+</span><span style="color:#24292E"> i][load_a_smem_m] </span><span style="color:#D73A49">=</span><span style="color:#24292E"> r_load_a[i];</span></span>
<span data-line><span style="color:#24292E">    }</span></span>
<span data-line> </span>
<span data-line><span style="color:#6F42C1">    CP_ASYNC_WAIT_GROUP</span><span style="color:#24292E">(</span><span style="color:#005CC5">0</span><span style="color:#24292E">);</span></span>
<span data-line><span style="color:#6F42C1">    __syncthreads</span><span style="color:#24292E">();</span></span>
<span data-line><span style="color:#24292E">  }</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">#pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">  for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> tk </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; tk </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> BK; tk</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#6F42C1">    FLOAT4</span><span style="color:#24292E">(r_comp_a[</span><span style="color:#005CC5">0</span><span style="color:#24292E">]) </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> FLOAT4</span><span style="color:#24292E">(s_a[</span><span style="color:#005CC5">1</span><span style="color:#24292E">][tk][ty </span><span style="color:#D73A49">*</span><span style="color:#24292E"> TM]);</span></span>
<span data-line><span style="color:#6F42C1">    FLOAT4</span><span style="color:#24292E">(r_comp_a[</span><span style="color:#005CC5">4</span><span style="color:#24292E">]) </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> FLOAT4</span><span style="color:#24292E">(s_a[</span><span style="color:#005CC5">1</span><span style="color:#24292E">][tk][ty </span><span style="color:#D73A49">*</span><span style="color:#24292E"> TM </span><span style="color:#D73A49">+</span><span style="color:#005CC5"> 4</span><span style="color:#24292E">]);</span></span>
<span data-line><span style="color:#6F42C1">    FLOAT4</span><span style="color:#24292E">(r_comp_b[</span><span style="color:#005CC5">0</span><span style="color:#24292E">]) </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> FLOAT4</span><span style="color:#24292E">(s_b[</span><span style="color:#005CC5">1</span><span style="color:#24292E">][tk][tx </span><span style="color:#D73A49">*</span><span style="color:#24292E"> TN]);</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">#pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">    for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> tm </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; tm </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> TM; tm</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#D73A49">#pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">      for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> tn </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; tn </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> TN; tn</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#24292E">        r_c[tm][tn] </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> __fmaf_rn</span><span style="color:#24292E">(r_comp_a[tm], r_comp_b[tn], r_c[tm][tn]);</span></span>
<span data-line><span style="color:#24292E">      }</span></span>
<span data-line><span style="color:#24292E">    }</span></span>
<span data-line><span style="color:#24292E">  }</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">#pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">  for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> i </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; i </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> TM; i</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> store_c_gmem_m </span><span style="color:#D73A49">=</span><span style="color:#24292E"> by </span><span style="color:#D73A49">*</span><span style="color:#24292E"> BM </span><span style="color:#D73A49">+</span><span style="color:#24292E"> ty </span><span style="color:#D73A49">*</span><span style="color:#24292E"> TM </span><span style="color:#D73A49">+</span><span style="color:#24292E"> i;</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> store_c_gmem_n </span><span style="color:#D73A49">=</span><span style="color:#24292E"> bx </span><span style="color:#D73A49">*</span><span style="color:#24292E"> BN </span><span style="color:#D73A49">+</span><span style="color:#24292E"> tx </span><span style="color:#D73A49">*</span><span style="color:#24292E"> TN;</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> store_c_gmem_addr </span><span style="color:#D73A49">=</span><span style="color:#24292E"> store_c_gmem_m </span><span style="color:#D73A49">*</span><span style="color:#24292E"> N </span><span style="color:#D73A49">+</span><span style="color:#24292E"> store_c_gmem_n;</span></span>
<span data-line><span style="color:#6F42C1">    FLOAT4</span><span style="color:#24292E">(c[store_c_gmem_addr]) </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> FLOAT4</span><span style="color:#24292E">(r_c[i][</span><span style="color:#005CC5">0</span><span style="color:#24292E">]);</span></span>
<span data-line><span style="color:#24292E">  }</span></span>
<span data-line><span style="color:#24292E">}</span></span></code></pre></figure>
<h1 id="reduce">reduce<a class="anchor" href="#reduce"><span class="icon icon-link"></span></a></h1>
<h2 id="reduce-sum">reduce sum<a class="anchor" href="#reduce-sum"><span class="icon icon-link"></span></a></h2>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="cpp" data-theme="github-light"><code data-language="cpp" data-theme="github-light" style="display:grid"><span data-line><span style="color:#D73A49">#define</span><span style="color:#6F42C1"> LDST128BITS</span><span style="color:#24292E">(</span><span style="color:#E36209">value</span><span style="color:#24292E">) (</span><span style="color:#D73A49">reinterpret_cast&lt;</span><span style="color:#24292E">float4</span><span style="color:#D73A49">*&gt;</span><span style="color:#24292E">(</span><span style="color:#D73A49">&amp;</span><span style="color:#24292E">(value))[</span><span style="color:#005CC5">0</span><span style="color:#24292E">])</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">// 先写warp-reduce函数</span></span>
<span data-line><span style="color:#D73A49">template</span><span style="color:#24292E">&lt;</span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> rWarpSize </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 32</span><span style="color:#24292E">&gt;</span></span>
<span data-line><span style="color:#24292E">__device__ __forceinline__ half </span><span style="color:#6F42C1">warp_reduce_f16_f16_sum</span><span style="color:#24292E">(half val) {</span></span>
<span data-line><span style="color:#D73A49">    #pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">    for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> mask </span><span style="color:#D73A49">=</span><span style="color:#24292E"> rWarpSize </span><span style="color:#D73A49">&gt;&gt;</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">; mask </span><span style="color:#D73A49">&gt;</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; mask </span><span style="color:#D73A49">&gt;&gt;=</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#24292E">        val </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> __hadd</span><span style="color:#24292E">(val, </span><span style="color:#6F42C1">__shfl_xor_sync</span><span style="color:#24292E">(</span><span style="color:#D73A49">0x</span><span style="color:#005CC5">fffffff</span><span style="color:#24292E">, val, mask));</span></span>
<span data-line><span style="color:#24292E">    }</span></span>
<span data-line><span style="color:#D73A49">    return</span><span style="color:#24292E"> val;</span></span>
<span data-line><span style="color:#24292E">}</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">// one row: N / 256 * 8 = N / 2048 blocks</span></span>
<span data-line><span style="color:#6A737D">// grid: row_num x (N / 2048)</span></span>
<span data-line><span style="color:#D73A49">template</span><span style="color:#24292E">&lt;</span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> NUM_THREADS </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 256</span><span style="color:#24292E">, </span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> BLOCK_ONE_ROW </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 2</span><span style="color:#24292E">&gt;</span></span>
<span data-line><span style="color:#24292E">__global__ </span><span style="color:#D73A49">void</span><span style="color:#6F42C1"> block_all_reduce_f16x8_2d_sum</span><span style="color:#24292E">(half</span><span style="color:#D73A49">*</span><span style="color:#24292E"> input, </span><span style="color:#D73A49">float*</span><span style="color:#24292E"> output, </span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> N) {</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> tid </span><span style="color:#D73A49">=</span><span style="color:#24292E"> threadIdx.x;</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> idx </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (blockIdx.x </span><span style="color:#D73A49">*</span><span style="color:#24292E"> NUM_THREADS </span><span style="color:#D73A49">+</span><span style="color:#24292E"> tid) </span><span style="color:#D73A49">*</span><span style="color:#005CC5"> 8</span><span style="color:#24292E">;</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> warp_id </span><span style="color:#D73A49">=</span><span style="color:#24292E"> tid </span><span style="color:#D73A49">/</span><span style="color:#24292E"> WARP_SIZE;</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> lane_id </span><span style="color:#D73A49">=</span><span style="color:#24292E"> tid </span><span style="color:#D73A49">%</span><span style="color:#24292E"> WARP_SIZE;</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">    constexpr</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> NUM_WARP </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (NUM_THREADS </span><span style="color:#D73A49">+</span><span style="color:#24292E"> WARP_SIZE </span><span style="color:#D73A49">-</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">) </span><span style="color:#D73A49">/</span><span style="color:#24292E"> WARP_SIZE;</span></span>
<span data-line><span style="color:#24292E">    __shared__ half reduce_sum_row[NUM_WARP];</span></span>
<span data-line> </span>
<span data-line><span style="color:#24292E">    half reg_a[NUM_WARP];</span></span>
<span data-line> </span>
<span data-line><span style="color:#6F42C1">    LDST128BITS</span><span style="color:#24292E">(reg_a[</span><span style="color:#005CC5">0</span><span style="color:#24292E">]) </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> LDST128BITS</span><span style="color:#24292E">(input[idx]);</span><span style="color:#6A737D">    // load to local thread register</span></span>
<span data-line> </span>
<span data-line><span style="color:#24292E">    half sum_fp16 </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> __float2half</span><span style="color:#24292E">(</span><span style="color:#005CC5">0.0</span><span style="color:#D73A49">f</span><span style="color:#24292E">);</span></span>
<span data-line><span style="color:#D73A49">    #pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">    for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> i </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; i </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> NUM_WARP; i</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#24292E">        sum_fp16 </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> __hadd</span><span style="color:#24292E">(sum_fp16, reg_a[i]);</span></span>
<span data-line><span style="color:#24292E">    }</span></span>
<span data-line><span style="color:#6A737D">    // printf(&quot;The sum: %f\n&quot;, __half2float(sum_fp16));</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">    // do warp - reduce</span></span>
<span data-line><span style="color:#24292E">    sum_fp16 </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> warp_reduce_f16_f16_sum</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">WARP_SIZE</span><span style="color:#24292E">&gt;(sum_fp16);</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">    // the first lane, store it to shared mem</span></span>
<span data-line><span style="color:#D73A49">    if</span><span style="color:#24292E"> (lane_id </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">) </span></span>
<span data-line><span style="color:#24292E">        reduce_sum_row[warp_id] </span><span style="color:#D73A49">=</span><span style="color:#24292E"> sum_fp16;</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">    // we will read, so we do a sync here</span></span>
<span data-line><span style="color:#6F42C1">    __syncthreads</span><span style="color:#24292E">();</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">    // the first warp reduce again to gather</span></span>
<span data-line><span style="color:#24292E">    half sum_fp16_1st </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (lane_id </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> NUM_WARP) </span><span style="color:#D73A49">?</span><span style="color:#24292E"> reduce_sum_row[lane_id] </span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> __float2half</span><span style="color:#24292E">(</span><span style="color:#005CC5">0.0</span><span style="color:#D73A49">f</span><span style="color:#24292E">);</span></span>
<span data-line><span style="color:#D73A49">    if</span><span style="color:#24292E"> (warp_id </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#24292E">        sum_fp16_1st </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> warp_reduce_f16_f16_sum</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">WARP_SIZE</span><span style="color:#24292E">&gt;(sum_fp16_1st);</span></span>
<span data-line><span style="color:#24292E">    }</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">    // load this to destination</span></span>
<span data-line><span style="color:#D73A49">    if</span><span style="color:#24292E"> (tid </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#6A737D">        // two block, calculate one row.</span></span>
<span data-line><span style="color:#D73A49">        int</span><span style="color:#24292E"> dest_idx </span><span style="color:#D73A49">=</span><span style="color:#24292E"> blockIdx.x </span><span style="color:#D73A49">/</span><span style="color:#24292E"> BLOCK_ONE_ROW;</span></span>
<span data-line><span style="color:#24292E">        </span></span>
<span data-line><span style="color:#6F42C1">        atomicAdd</span><span style="color:#24292E">(output </span><span style="color:#D73A49">+</span><span style="color:#24292E"> dest_idx, </span><span style="color:#6F42C1">__half2float</span><span style="color:#24292E">(sum_fp16_1st));</span></span>
<span data-line><span style="color:#24292E">    }</span></span>
<span data-line><span style="color:#24292E">}</span></span></code></pre></figure>
<h2 id="reduce-max">reduce max<a class="anchor" href="#reduce-max"><span class="icon icon-link"></span></a></h2>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="cpp" data-theme="github-light"><code data-language="cpp" data-theme="github-light" style="display:grid"><span data-line><span style="color:#D73A49">#define</span><span style="color:#6F42C1"> WARP_SIZE</span><span style="color:#005CC5"> 32</span></span>
<span data-line><span style="color:#D73A49">#define</span><span style="color:#6F42C1"> LDST128BITS</span><span style="color:#24292E">(</span><span style="color:#E36209">value</span><span style="color:#24292E">) (</span><span style="color:#D73A49">reinterpret_cast&lt;</span><span style="color:#24292E">float4</span><span style="color:#D73A49">*&gt;</span><span style="color:#24292E">(</span><span style="color:#D73A49">&amp;</span><span style="color:#24292E">(value))[</span><span style="color:#005CC5">0</span><span style="color:#24292E">])</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">template</span><span style="color:#24292E">&lt;</span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> rWarpSize </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 32</span><span style="color:#24292E">&gt;</span></span>
<span data-line><span style="color:#24292E">__device__ __forceinline__ half </span><span style="color:#6F42C1">warp_reduce_f16_f16_max</span><span style="color:#24292E">(half val) {</span></span>
<span data-line><span style="color:#D73A49">    #pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">    for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> mask </span><span style="color:#D73A49">=</span><span style="color:#24292E"> rWarpSize </span><span style="color:#D73A49">&gt;&gt;</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">; mask </span><span style="color:#D73A49">&gt;</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; mask </span><span style="color:#D73A49">&gt;&gt;=</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#24292E">        half buf </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> __shfl_xor_sync</span><span style="color:#24292E">(</span><span style="color:#D73A49">0x</span><span style="color:#005CC5">fffffff</span><span style="color:#24292E">, val, mask);</span></span>
<span data-line><span style="color:#24292E">        val </span><span style="color:#D73A49">=</span><span style="color:#24292E"> val </span><span style="color:#D73A49">&gt;</span><span style="color:#24292E"> buf </span><span style="color:#D73A49">?</span><span style="color:#24292E"> val </span><span style="color:#D73A49">:</span><span style="color:#24292E"> buf;</span></span>
<span data-line><span style="color:#24292E">    }</span></span>
<span data-line><span style="color:#D73A49">    return</span><span style="color:#24292E"> val;</span></span>
<span data-line><span style="color:#24292E">}</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">// 需要这样一个CAS的max函数，做原子操作</span></span>
<span data-line><span style="color:#24292E">__device__ </span><span style="color:#D73A49">static</span><span style="color:#D73A49"> float</span><span style="color:#6F42C1"> atomicMax</span><span style="color:#24292E">(</span><span style="color:#D73A49">float*</span><span style="color:#24292E"> address, </span><span style="color:#D73A49">float</span><span style="color:#24292E"> val) {</span></span>
<span data-line><span style="color:#D73A49">    int*</span><span style="color:#24292E"> address_as_i </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int*</span><span style="color:#24292E">)address;</span><span style="color:#6A737D">  // address转为int指针</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> old </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> *</span><span style="color:#24292E">address_as_i;</span><span style="color:#6A737D">  // address中的旧值，用int解码</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> assumed;</span></span>
<span data-line><span style="color:#D73A49">    do</span><span style="color:#24292E"> {</span></span>
<span data-line><span style="color:#24292E">        assumed </span><span style="color:#D73A49">=</span><span style="color:#24292E"> old;</span><span style="color:#6A737D">  // assumed存储旧值</span></span>
<span data-line><span style="color:#24292E">        old </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> atomicCAS</span><span style="color:#24292E">(address_as_i, assumed, </span><span style="color:#6F42C1">__float_as_int</span><span style="color:#24292E">(</span><span style="color:#6F42C1">fmaxf</span><span style="color:#24292E">(val, </span><span style="color:#6F42C1">__int_as_float</span><span style="color:#24292E">(assumed))));</span></span>
<span data-line><span style="color:#24292E">    } </span><span style="color:#D73A49">while</span><span style="color:#24292E"> (assumed </span><span style="color:#D73A49">!=</span><span style="color:#24292E"> old);</span></span>
<span data-line><span style="color:#D73A49">    return</span><span style="color:#6F42C1"> __int_as_float</span><span style="color:#24292E">(old);</span></span>
<span data-line><span style="color:#24292E">}</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">// one row: N / 256 * 8 = N / 2048 blocks</span></span>
<span data-line><span style="color:#6A737D">// grid: row_num x (N / 2048)</span></span>
<span data-line><span style="color:#D73A49">template</span><span style="color:#24292E">&lt;</span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> NUM_THREADS </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 256</span><span style="color:#24292E">, </span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> BLOCK_ONE_ROW </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 2</span><span style="color:#24292E">&gt;</span></span>
<span data-line><span style="color:#24292E">__global__ </span><span style="color:#D73A49">void</span><span style="color:#6F42C1"> block_all_reduce_f16x8_2d_max</span><span style="color:#24292E">(half</span><span style="color:#D73A49">*</span><span style="color:#24292E"> input, </span><span style="color:#D73A49">float*</span><span style="color:#24292E"> output, </span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> N) {</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> tid </span><span style="color:#D73A49">=</span><span style="color:#24292E"> threadIdx.x;</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> idx </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (blockIdx.x </span><span style="color:#D73A49">*</span><span style="color:#24292E"> NUM_THREADS </span><span style="color:#D73A49">+</span><span style="color:#24292E"> tid) </span><span style="color:#D73A49">*</span><span style="color:#005CC5"> 8</span><span style="color:#24292E">;</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> warp_id </span><span style="color:#D73A49">=</span><span style="color:#24292E"> tid </span><span style="color:#D73A49">/</span><span style="color:#24292E"> WARP_SIZE;</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> lane_id </span><span style="color:#D73A49">=</span><span style="color:#24292E"> tid </span><span style="color:#D73A49">%</span><span style="color:#24292E"> WARP_SIZE;</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">    constexpr</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> NUM_WARP </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (NUM_THREADS </span><span style="color:#D73A49">+</span><span style="color:#24292E"> WARP_SIZE </span><span style="color:#D73A49">-</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">) </span><span style="color:#D73A49">/</span><span style="color:#24292E"> WARP_SIZE;</span></span>
<span data-line><span style="color:#24292E">    __shared__ half reduce_max_row[NUM_WARP];</span></span>
<span data-line> </span>
<span data-line><span style="color:#24292E">    half reg_a[NUM_WARP];</span></span>
<span data-line> </span>
<span data-line><span style="color:#6F42C1">    LDST128BITS</span><span style="color:#24292E">(reg_a[</span><span style="color:#005CC5">0</span><span style="color:#24292E">]) </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> LDST128BITS</span><span style="color:#24292E">(input[idx]);</span><span style="color:#6A737D">    // load to local thread register</span></span>
<span data-line> </span>
<span data-line><span style="color:#24292E">    half max_fp16 </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> __float2half</span><span style="color:#24292E">(</span><span style="color:#005CC5">0.0</span><span style="color:#D73A49">f</span><span style="color:#24292E">);</span></span>
<span data-line><span style="color:#D73A49">    #pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">    for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> i </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; i </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> NUM_WARP; i</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#24292E">        max_fp16 </span><span style="color:#D73A49">=</span><span style="color:#24292E"> max_fp16 </span><span style="color:#D73A49">&gt;</span><span style="color:#24292E"> reg_a[i] </span><span style="color:#D73A49">?</span><span style="color:#24292E"> max_fp16 </span><span style="color:#D73A49">:</span><span style="color:#24292E"> reg_a[i];</span></span>
<span data-line><span style="color:#24292E">    }</span></span>
<span data-line><span style="color:#6A737D">    // printf(&quot;The sum: %f\n&quot;, __half2float(sum_fp16));</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">    // do warp - reduce</span></span>
<span data-line><span style="color:#24292E">    max_fp16 </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> warp_reduce_f16_f16_max</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">WARP_SIZE</span><span style="color:#24292E">&gt;(max_fp16);</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">    // the first lane, store it to shared mem</span></span>
<span data-line><span style="color:#D73A49">    if</span><span style="color:#24292E"> (lane_id </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">) </span></span>
<span data-line><span style="color:#24292E">        reduce_max_row[warp_id] </span><span style="color:#D73A49">=</span><span style="color:#24292E"> max_fp16;</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">    // we will read, so we do a sync here</span></span>
<span data-line><span style="color:#6F42C1">    __syncthreads</span><span style="color:#24292E">();</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">    // the first warp reduce again to gather</span></span>
<span data-line><span style="color:#24292E">    half max_fp16_1st </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (lane_id </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> NUM_WARP) </span><span style="color:#D73A49">?</span><span style="color:#24292E"> reduce_max_row[lane_id] </span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> __float2half</span><span style="color:#24292E">(</span><span style="color:#005CC5">0.0</span><span style="color:#D73A49">f</span><span style="color:#24292E">);</span></span>
<span data-line><span style="color:#D73A49">    if</span><span style="color:#24292E"> (warp_id </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#24292E">        max_fp16_1st </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> warp_reduce_f16_f16_max</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">WARP_SIZE</span><span style="color:#24292E">&gt;(max_fp16_1st);</span></span>
<span data-line><span style="color:#24292E">    }</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">    // load this to destination</span></span>
<span data-line><span style="color:#D73A49">    if</span><span style="color:#24292E"> (tid </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#6A737D">        // two block, calculate one row.</span></span>
<span data-line><span style="color:#D73A49">        int</span><span style="color:#24292E"> dest_idx </span><span style="color:#D73A49">=</span><span style="color:#24292E"> blockIdx.x </span><span style="color:#D73A49">/</span><span style="color:#24292E"> BLOCK_ONE_ROW;</span></span>
<span data-line><span style="color:#24292E">        half original </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> *</span><span style="color:#24292E">(output </span><span style="color:#D73A49">+</span><span style="color:#24292E"> dest_idx);</span></span>
<span data-line><span style="color:#6A737D">        // atomicAdd(output + dest_idx, __half2float(sum_fp16_1st));  // 这里改为做一个CAS</span></span>
<span data-line><span style="color:#6F42C1">        atomicMax</span><span style="color:#24292E">(output </span><span style="color:#D73A49">+</span><span style="color:#24292E"> dest_idx, </span><span style="color:#6F42C1">__half2float</span><span style="color:#24292E">(max_fp16_1st));</span></span>
<span data-line><span style="color:#24292E">    }</span></span>
<span data-line><span style="color:#24292E">}</span></span></code></pre></figure>
<h1 id="softmax">softmax<a class="anchor" href="#softmax"><span class="icon icon-link"></span></a></h1>
<p>首先讲清楚Softmax的公式是：</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><msup><mi>e</mi><msub><mi>z</mi><mi>i</mi></msub></msup><mrow><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msup><mi>e</mi><msub><mi>z</mi><mi>j</mi></msub></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{e^{z_i}}{\sum_{j=1}^{K}e^{z_j}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.6484em;vertical-align:-1.307em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3414em"><span style="top:-2.1288em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em">K</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6065em"><span style="top:-3.0051em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em"><span style="top:-2.357em;margin-left:-0.044em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em"><span style="top:-2.357em;margin-left:-0.044em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>
<p>在这里又有sum又有exp又有element-wise除法的，难搞。</p>
<h2 id="普通softmax">普通softmax<a class="anchor" href="#普通softmax"><span class="icon icon-link"></span></a></h2>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="cpp" data-theme="github-light"><code data-language="cpp" data-theme="github-light" style="display:grid"><span data-line><span style="color:#D73A49">template</span><span style="color:#24292E"> &lt;</span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#6F42C1"> kWarpSize</span><span style="color:#D73A49"> =</span><span style="color:#24292E"> WARP_SIZE&gt;</span></span>
<span data-line><span style="color:#24292E">__device__ __forceinline__ </span><span style="color:#D73A49">float</span><span style="color:#6F42C1"> warp_reduce_sum_f32</span><span style="color:#24292E">(</span><span style="color:#D73A49">float</span><span style="color:#24292E"> val) {</span></span>
<span data-line><span style="color:#D73A49">#pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">  for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> mask </span><span style="color:#D73A49">=</span><span style="color:#24292E"> kWarpSize </span><span style="color:#D73A49">&gt;&gt;</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">; mask </span><span style="color:#D73A49">&gt;=</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">; mask </span><span style="color:#D73A49">&gt;&gt;=</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#24292E">    val </span><span style="color:#D73A49">+=</span><span style="color:#6F42C1"> __shfl_xor_sync</span><span style="color:#24292E">(</span><span style="color:#D73A49">0x</span><span style="color:#005CC5">ffffffff</span><span style="color:#24292E">, val, mask);</span></span>
<span data-line><span style="color:#24292E">  }</span></span>
<span data-line><span style="color:#D73A49">  return</span><span style="color:#24292E"> val;</span></span>
<span data-line><span style="color:#24292E">}</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">// grid 1D block 1D, grid(N/256), block(256)</span></span>
<span data-line><span style="color:#D73A49">template</span><span style="color:#24292E"> &lt;</span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> NUM_THREADS </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 256</span><span style="color:#24292E">&gt;</span></span>
<span data-line><span style="color:#24292E">__device__ </span><span style="color:#D73A49">float</span><span style="color:#6F42C1"> block_reduce_sum_f32</span><span style="color:#24292E">(</span><span style="color:#D73A49">float</span><span style="color:#24292E"> val) {</span></span>
<span data-line><span style="color:#6A737D">  // always &lt;= 32 warps per block (limited by 1024 threads per block)</span></span>
<span data-line><span style="color:#D73A49">  constexpr</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> NUM_WARPS </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (NUM_THREADS </span><span style="color:#D73A49">+</span><span style="color:#24292E"> WARP_SIZE </span><span style="color:#D73A49">-</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">) </span><span style="color:#D73A49">/</span><span style="color:#24292E"> WARP_SIZE;</span></span>
<span data-line><span style="color:#D73A49">  int</span><span style="color:#24292E"> warp </span><span style="color:#D73A49">=</span><span style="color:#24292E"> threadIdx.x </span><span style="color:#D73A49">/</span><span style="color:#24292E"> WARP_SIZE;</span></span>
<span data-line><span style="color:#D73A49">  int</span><span style="color:#24292E"> lane </span><span style="color:#D73A49">=</span><span style="color:#24292E"> threadIdx.x </span><span style="color:#D73A49">%</span><span style="color:#24292E"> WARP_SIZE;</span></span>
<span data-line><span style="color:#D73A49">  static</span><span style="color:#24292E"> __shared__ </span><span style="color:#D73A49">float</span><span style="color:#24292E"> shared[NUM_WARPS];</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">  float</span><span style="color:#24292E"> value </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> warp_reduce_sum_f32</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">WARP_SIZE</span><span style="color:#24292E">&gt;(val);</span></span>
<span data-line><span style="color:#D73A49">  if</span><span style="color:#24292E"> (lane </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">)</span></span>
<span data-line><span style="color:#24292E">    shared[warp] </span><span style="color:#D73A49">=</span><span style="color:#24292E"> value;</span></span>
<span data-line><span style="color:#6F42C1">  __syncthreads</span><span style="color:#24292E">();</span></span>
<span data-line><span style="color:#24292E">  value </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (lane </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> NUM_WARPS) </span><span style="color:#D73A49">?</span><span style="color:#24292E"> shared[lane] </span><span style="color:#D73A49">:</span><span style="color:#005CC5"> 0.0</span><span style="color:#D73A49">f</span><span style="color:#24292E">;</span></span>
<span data-line><span style="color:#24292E">  value </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> warp_reduce_sum_f32</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">NUM_WARPS</span><span style="color:#24292E">&gt;(value);</span></span>
<span data-line><span style="color:#6A737D">  // WRAN: need to broadcast value to all threads within warp</span></span>
<span data-line><span style="color:#24292E">  value </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> __shfl_sync</span><span style="color:#24292E">(</span><span style="color:#D73A49">0x</span><span style="color:#005CC5">ffffffff</span><span style="color:#24292E">, value, </span><span style="color:#005CC5">0</span><span style="color:#24292E">, </span><span style="color:#005CC5">32</span><span style="color:#24292E">);</span></span>
<span data-line><span style="color:#D73A49">  return</span><span style="color:#24292E"> value;</span></span>
<span data-line><span style="color:#24292E">}</span></span>
<span data-line> </span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">// f32x4</span></span>
<span data-line><span style="color:#D73A49">template</span><span style="color:#24292E"> &lt;</span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> NUM_THREADS </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 256</span><span style="color:#D73A49"> /</span><span style="color:#005CC5"> 4</span><span style="color:#24292E">&gt;</span></span>
<span data-line><span style="color:#24292E">__global__ </span><span style="color:#D73A49">void</span><span style="color:#6F42C1"> softmax_f32x4_per_token_kernel</span><span style="color:#24292E">(</span><span style="color:#D73A49">float</span><span style="color:#D73A49"> *</span><span style="color:#24292E">x, </span><span style="color:#D73A49">float</span><span style="color:#D73A49"> *</span><span style="color:#24292E">y, </span><span style="color:#D73A49">int</span><span style="color:#24292E"> N) {</span></span>
<span data-line><span style="color:#D73A49">  const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> tid </span><span style="color:#D73A49">=</span><span style="color:#24292E"> threadIdx.x;</span></span>
<span data-line><span style="color:#D73A49">  const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> idx </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (blockIdx.x </span><span style="color:#D73A49">*</span><span style="color:#24292E"> blockDim.x </span><span style="color:#D73A49">+</span><span style="color:#24292E"> tid) </span><span style="color:#D73A49">*</span><span style="color:#005CC5"> 4</span><span style="color:#24292E">;</span></span>
<span data-line> </span>
<span data-line><span style="color:#24292E">  float4 reg_x </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> FLOAT4</span><span style="color:#24292E">(x[idx]);</span></span>
<span data-line><span style="color:#24292E">  float4 reg_exp;</span></span>
<span data-line><span style="color:#24292E">  reg_exp.x </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (idx </span><span style="color:#D73A49">+</span><span style="color:#005CC5"> 0</span><span style="color:#D73A49"> &lt;</span><span style="color:#24292E"> N) </span><span style="color:#D73A49">?</span><span style="color:#6F42C1"> expf</span><span style="color:#24292E">(reg_x.x) </span><span style="color:#D73A49">:</span><span style="color:#005CC5"> 0.0</span><span style="color:#D73A49">f</span><span style="color:#24292E">;</span></span>
<span data-line><span style="color:#24292E">  reg_exp.y </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (idx </span><span style="color:#D73A49">+</span><span style="color:#005CC5"> 1</span><span style="color:#D73A49"> &lt;</span><span style="color:#24292E"> N) </span><span style="color:#D73A49">?</span><span style="color:#6F42C1"> expf</span><span style="color:#24292E">(reg_x.y) </span><span style="color:#D73A49">:</span><span style="color:#005CC5"> 0.0</span><span style="color:#D73A49">f</span><span style="color:#24292E">;</span></span>
<span data-line><span style="color:#24292E">  reg_exp.z </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (idx </span><span style="color:#D73A49">+</span><span style="color:#005CC5"> 2</span><span style="color:#D73A49"> &lt;</span><span style="color:#24292E"> N) </span><span style="color:#D73A49">?</span><span style="color:#6F42C1"> expf</span><span style="color:#24292E">(reg_x.z) </span><span style="color:#D73A49">:</span><span style="color:#005CC5"> 0.0</span><span style="color:#D73A49">f</span><span style="color:#24292E">;</span></span>
<span data-line><span style="color:#24292E">  reg_exp.w </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (idx </span><span style="color:#D73A49">+</span><span style="color:#005CC5"> 3</span><span style="color:#D73A49"> &lt;</span><span style="color:#24292E"> N) </span><span style="color:#D73A49">?</span><span style="color:#6F42C1"> expf</span><span style="color:#24292E">(reg_x.w) </span><span style="color:#D73A49">:</span><span style="color:#005CC5"> 0.0</span><span style="color:#D73A49">f</span><span style="color:#24292E">;</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">  float</span><span style="color:#24292E"> exp_val </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (reg_exp.x </span><span style="color:#D73A49">+</span><span style="color:#24292E"> reg_exp.y </span><span style="color:#D73A49">+</span><span style="color:#24292E"> reg_exp.z </span><span style="color:#D73A49">+</span><span style="color:#24292E"> reg_exp.w);</span></span>
<span data-line><span style="color:#D73A49">  float</span><span style="color:#24292E"> exp_sum </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> block_reduce_sum_f32</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">NUM_THREADS</span><span style="color:#24292E">&gt;(exp_val);</span><span style="color:#6A737D"> // block sum</span></span>
<span data-line><span style="color:#6A737D">  // e^x_i/sum(e^x_0,...,e^x_n-1)</span></span>
<span data-line><span style="color:#D73A49">  if</span><span style="color:#24292E"> (idx </span><span style="color:#D73A49">+</span><span style="color:#005CC5"> 3</span><span style="color:#D73A49"> &lt;</span><span style="color:#24292E"> N) {</span></span>
<span data-line><span style="color:#24292E">    float4 reg_y;</span></span>
<span data-line><span style="color:#24292E">    reg_y.x </span><span style="color:#D73A49">=</span><span style="color:#24292E"> reg_exp.x </span><span style="color:#D73A49">/</span><span style="color:#24292E"> (exp_sum);</span></span>
<span data-line><span style="color:#24292E">    reg_y.y </span><span style="color:#D73A49">=</span><span style="color:#24292E"> reg_exp.y </span><span style="color:#D73A49">/</span><span style="color:#24292E"> (exp_sum);</span></span>
<span data-line><span style="color:#24292E">    reg_y.z </span><span style="color:#D73A49">=</span><span style="color:#24292E"> reg_exp.z </span><span style="color:#D73A49">/</span><span style="color:#24292E"> (exp_sum);</span></span>
<span data-line><span style="color:#24292E">    reg_y.w </span><span style="color:#D73A49">=</span><span style="color:#24292E"> reg_exp.w </span><span style="color:#D73A49">/</span><span style="color:#24292E"> (exp_sum);</span></span>
<span data-line><span style="color:#6F42C1">    FLOAT4</span><span style="color:#24292E">(y[idx]) </span><span style="color:#D73A49">=</span><span style="color:#24292E"> reg_y;</span></span>
<span data-line><span style="color:#24292E">  }</span></span>
<span data-line><span style="color:#24292E">}</span></span></code></pre></figure>
<h2 id="safe-softmax">Safe softmax<a class="anchor" href="#safe-softmax"><span class="icon icon-link"></span></a></h2>
<p>其实Safe softmax就是多了一个减去最大值的操作，这个很重要，避免到了最后数值爆炸</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="cpp" data-theme="github-light"><code data-language="cpp" data-theme="github-light" style="display:grid"><span data-line><span style="color:#6A737D">// Warp Reduce Max</span></span>
<span data-line><span style="color:#D73A49">template</span><span style="color:#24292E"> &lt;</span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#6F42C1"> kWarpSize</span><span style="color:#D73A49"> =</span><span style="color:#24292E"> WARP_SIZE&gt;</span></span>
<span data-line><span style="color:#24292E">__device__ __forceinline__ </span><span style="color:#D73A49">float</span><span style="color:#6F42C1"> warp_reduce_max_f32</span><span style="color:#24292E">(</span><span style="color:#D73A49">float</span><span style="color:#24292E"> val) {</span></span>
<span data-line><span style="color:#D73A49">#pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">  for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> mask </span><span style="color:#D73A49">=</span><span style="color:#24292E"> kWarpSize </span><span style="color:#D73A49">&gt;&gt;</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">; mask </span><span style="color:#D73A49">&gt;=</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">; mask </span><span style="color:#D73A49">&gt;&gt;=</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#24292E">    val </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> fmaxf</span><span style="color:#24292E">(val, </span><span style="color:#6F42C1">__shfl_xor_sync</span><span style="color:#24292E">(</span><span style="color:#D73A49">0x</span><span style="color:#005CC5">ffffffff</span><span style="color:#24292E">, val, mask));</span></span>
<span data-line><span style="color:#24292E">  }</span></span>
<span data-line><span style="color:#D73A49">  return</span><span style="color:#24292E"> val;</span></span>
<span data-line><span style="color:#24292E">}</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">template</span><span style="color:#24292E"> &lt;</span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> NUM_THREADS </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 256</span><span style="color:#24292E">&gt;</span></span>
<span data-line><span style="color:#24292E">__device__ </span><span style="color:#D73A49">float</span><span style="color:#6F42C1"> block_reduce_max_f32</span><span style="color:#24292E">(</span><span style="color:#D73A49">float</span><span style="color:#24292E"> val) {</span></span>
<span data-line><span style="color:#6A737D">  // always &lt;= 32 warps per block (limited by 1024 threads per block)</span></span>
<span data-line><span style="color:#D73A49">  constexpr</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> NUM_WARPS </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (NUM_THREADS </span><span style="color:#D73A49">+</span><span style="color:#24292E"> WARP_SIZE </span><span style="color:#D73A49">-</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">) </span><span style="color:#D73A49">/</span><span style="color:#24292E"> WARP_SIZE;</span></span>
<span data-line><span style="color:#D73A49">  int</span><span style="color:#24292E"> warp </span><span style="color:#D73A49">=</span><span style="color:#24292E"> threadIdx.x </span><span style="color:#D73A49">/</span><span style="color:#24292E"> WARP_SIZE;</span></span>
<span data-line><span style="color:#D73A49">  int</span><span style="color:#24292E"> lane </span><span style="color:#D73A49">=</span><span style="color:#24292E"> threadIdx.x </span><span style="color:#D73A49">%</span><span style="color:#24292E"> WARP_SIZE;</span></span>
<span data-line><span style="color:#D73A49">  static</span><span style="color:#24292E"> __shared__ </span><span style="color:#D73A49">float</span><span style="color:#24292E"> shared[NUM_WARPS];</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">  float</span><span style="color:#24292E"> value </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> warp_reduce_max_f32</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">WARP_SIZE</span><span style="color:#24292E">&gt;(val);</span></span>
<span data-line><span style="color:#D73A49">  if</span><span style="color:#24292E"> (lane </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">)</span></span>
<span data-line><span style="color:#24292E">    shared[warp] </span><span style="color:#D73A49">=</span><span style="color:#24292E"> value;</span></span>
<span data-line><span style="color:#6F42C1">  __syncthreads</span><span style="color:#24292E">();</span></span>
<span data-line><span style="color:#24292E">  value </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (lane </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> NUM_WARPS) </span><span style="color:#D73A49">?</span><span style="color:#24292E"> shared[lane] </span><span style="color:#D73A49">:</span><span style="color:#D73A49"> -</span><span style="color:#24292E">FLT_MAX;</span></span>
<span data-line><span style="color:#24292E">  value </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> warp_reduce_max_f32</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">NUM_WARPS</span><span style="color:#24292E">&gt;(value);</span></span>
<span data-line><span style="color:#6A737D">  // WRAN: need to broadcast value to all threads within warp</span></span>
<span data-line><span style="color:#24292E">  value </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> __shfl_sync</span><span style="color:#24292E">(</span><span style="color:#D73A49">0x</span><span style="color:#005CC5">ffffffff</span><span style="color:#24292E">, value, </span><span style="color:#005CC5">0</span><span style="color:#24292E">, </span><span style="color:#005CC5">32</span><span style="color:#24292E">);</span></span>
<span data-line><span style="color:#D73A49">  return</span><span style="color:#24292E"> value;</span></span>
<span data-line><span style="color:#24292E">}</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">// safe softmax</span></span>
<span data-line><span style="color:#D73A49">template</span><span style="color:#24292E"> &lt;</span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> NUM_THREADS </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 256</span><span style="color:#D73A49"> /</span><span style="color:#005CC5"> 4</span><span style="color:#24292E">&gt;</span></span>
<span data-line><span style="color:#24292E">__global__ </span><span style="color:#D73A49">void</span><span style="color:#6F42C1"> safe_softmax_f32x4_per_token_kernel</span><span style="color:#24292E">(</span><span style="color:#D73A49">float</span><span style="color:#D73A49"> *</span><span style="color:#24292E">x, </span><span style="color:#D73A49">float</span><span style="color:#D73A49"> *</span><span style="color:#24292E">y, </span><span style="color:#D73A49">int</span><span style="color:#24292E"> N) {</span></span>
<span data-line><span style="color:#D73A49">  const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> tid </span><span style="color:#D73A49">=</span><span style="color:#24292E"> threadIdx.x;</span></span>
<span data-line><span style="color:#D73A49">  const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> idx </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (blockIdx.x </span><span style="color:#D73A49">*</span><span style="color:#24292E"> blockDim.x </span><span style="color:#D73A49">+</span><span style="color:#24292E"> tid) </span><span style="color:#D73A49">*</span><span style="color:#005CC5"> 4</span><span style="color:#24292E">;</span></span>
<span data-line> </span>
<span data-line><span style="color:#24292E">  float4 reg_x </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> FLOAT4</span><span style="color:#24292E">(x[idx]);</span></span>
<span data-line><span style="color:#24292E">  reg_x.x </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (idx </span><span style="color:#D73A49">+</span><span style="color:#005CC5"> 0</span><span style="color:#D73A49"> &lt;</span><span style="color:#24292E"> N) </span><span style="color:#D73A49">?</span><span style="color:#24292E"> reg_x.x </span><span style="color:#D73A49">:</span><span style="color:#D73A49"> -</span><span style="color:#24292E">FLT_MAX;</span></span>
<span data-line><span style="color:#24292E">  reg_x.y </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (idx </span><span style="color:#D73A49">+</span><span style="color:#005CC5"> 1</span><span style="color:#D73A49"> &lt;</span><span style="color:#24292E"> N) </span><span style="color:#D73A49">?</span><span style="color:#24292E"> reg_x.y </span><span style="color:#D73A49">:</span><span style="color:#D73A49"> -</span><span style="color:#24292E">FLT_MAX;</span></span>
<span data-line><span style="color:#24292E">  reg_x.z </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (idx </span><span style="color:#D73A49">+</span><span style="color:#005CC5"> 2</span><span style="color:#D73A49"> &lt;</span><span style="color:#24292E"> N) </span><span style="color:#D73A49">?</span><span style="color:#24292E"> reg_x.z </span><span style="color:#D73A49">:</span><span style="color:#D73A49"> -</span><span style="color:#24292E">FLT_MAX;</span></span>
<span data-line><span style="color:#24292E">  reg_x.w </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (idx </span><span style="color:#D73A49">+</span><span style="color:#005CC5"> 3</span><span style="color:#D73A49"> &lt;</span><span style="color:#24292E"> N) </span><span style="color:#D73A49">?</span><span style="color:#24292E"> reg_x.w </span><span style="color:#D73A49">:</span><span style="color:#D73A49"> -</span><span style="color:#24292E">FLT_MAX;</span></span>
<span data-line><span style="color:#D73A49">  float</span><span style="color:#24292E"> val </span><span style="color:#D73A49">=</span><span style="color:#24292E"> reg_x.x;</span></span>
<span data-line><span style="color:#24292E">  val </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> fmaxf</span><span style="color:#24292E">(val, reg_x.y);</span></span>
<span data-line><span style="color:#24292E">  val </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> fmaxf</span><span style="color:#24292E">(val, reg_x.z);</span></span>
<span data-line><span style="color:#24292E">  val </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> fmaxf</span><span style="color:#24292E">(val, reg_x.w);</span></span>
<span data-line><span style="color:#D73A49">  float</span><span style="color:#24292E"> max_val </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> block_reduce_max_f32</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">NUM_THREADS</span><span style="color:#24292E">&gt;(val);</span><span style="color:#6A737D"> // block max</span></span>
<span data-line> </span>
<span data-line><span style="color:#24292E">  float4 reg_exp;</span></span>
<span data-line><span style="color:#24292E">  reg_exp.x </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (idx </span><span style="color:#D73A49">+</span><span style="color:#005CC5"> 0</span><span style="color:#D73A49"> &lt;</span><span style="color:#24292E"> N) </span><span style="color:#D73A49">?</span><span style="color:#6F42C1"> expf</span><span style="color:#24292E">(reg_x.x </span><span style="color:#D73A49">-</span><span style="color:#24292E"> max_val) </span><span style="color:#D73A49">:</span><span style="color:#005CC5"> 0.0</span><span style="color:#D73A49">f</span><span style="color:#24292E">;</span></span>
<span data-line><span style="color:#24292E">  reg_exp.y </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (idx </span><span style="color:#D73A49">+</span><span style="color:#005CC5"> 1</span><span style="color:#D73A49"> &lt;</span><span style="color:#24292E"> N) </span><span style="color:#D73A49">?</span><span style="color:#6F42C1"> expf</span><span style="color:#24292E">(reg_x.y </span><span style="color:#D73A49">-</span><span style="color:#24292E"> max_val) </span><span style="color:#D73A49">:</span><span style="color:#005CC5"> 0.0</span><span style="color:#D73A49">f</span><span style="color:#24292E">;</span></span>
<span data-line><span style="color:#24292E">  reg_exp.z </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (idx </span><span style="color:#D73A49">+</span><span style="color:#005CC5"> 2</span><span style="color:#D73A49"> &lt;</span><span style="color:#24292E"> N) </span><span style="color:#D73A49">?</span><span style="color:#6F42C1"> expf</span><span style="color:#24292E">(reg_x.z </span><span style="color:#D73A49">-</span><span style="color:#24292E"> max_val) </span><span style="color:#D73A49">:</span><span style="color:#005CC5"> 0.0</span><span style="color:#D73A49">f</span><span style="color:#24292E">;</span></span>
<span data-line><span style="color:#24292E">  reg_exp.w </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (idx </span><span style="color:#D73A49">+</span><span style="color:#005CC5"> 3</span><span style="color:#D73A49"> &lt;</span><span style="color:#24292E"> N) </span><span style="color:#D73A49">?</span><span style="color:#6F42C1"> expf</span><span style="color:#24292E">(reg_x.w </span><span style="color:#D73A49">-</span><span style="color:#24292E"> max_val) </span><span style="color:#D73A49">:</span><span style="color:#005CC5"> 0.0</span><span style="color:#D73A49">f</span><span style="color:#24292E">;</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">  float</span><span style="color:#24292E"> exp_val </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (reg_exp.x </span><span style="color:#D73A49">+</span><span style="color:#24292E"> reg_exp.y </span><span style="color:#D73A49">+</span><span style="color:#24292E"> reg_exp.z </span><span style="color:#D73A49">+</span><span style="color:#24292E"> reg_exp.w);</span></span>
<span data-line><span style="color:#D73A49">  float</span><span style="color:#24292E"> exp_sum </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> block_reduce_sum_f32</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">NUM_THREADS</span><span style="color:#24292E">&gt;(exp_val);</span><span style="color:#6A737D"> // block sum</span></span>
<span data-line><span style="color:#6A737D">  // e^x_i/sum(e^x_0,...,e^x_n-1)</span></span>
<span data-line><span style="color:#D73A49">  if</span><span style="color:#24292E"> (idx </span><span style="color:#D73A49">+</span><span style="color:#005CC5"> 3</span><span style="color:#D73A49"> &lt;</span><span style="color:#24292E"> N) {</span></span>
<span data-line><span style="color:#24292E">    float4 reg_y;</span></span>
<span data-line><span style="color:#24292E">    reg_y.x </span><span style="color:#D73A49">=</span><span style="color:#24292E"> reg_exp.x </span><span style="color:#D73A49">/</span><span style="color:#24292E"> (exp_sum);</span></span>
<span data-line><span style="color:#24292E">    reg_y.y </span><span style="color:#D73A49">=</span><span style="color:#24292E"> reg_exp.y </span><span style="color:#D73A49">/</span><span style="color:#24292E"> (exp_sum);</span></span>
<span data-line><span style="color:#24292E">    reg_y.z </span><span style="color:#D73A49">=</span><span style="color:#24292E"> reg_exp.z </span><span style="color:#D73A49">/</span><span style="color:#24292E"> (exp_sum);</span></span>
<span data-line><span style="color:#24292E">    reg_y.w </span><span style="color:#D73A49">=</span><span style="color:#24292E"> reg_exp.w </span><span style="color:#D73A49">/</span><span style="color:#24292E"> (exp_sum);</span></span>
<span data-line><span style="color:#6F42C1">    FLOAT4</span><span style="color:#24292E">(y[idx]) </span><span style="color:#D73A49">=</span><span style="color:#24292E"> reg_y;</span></span>
<span data-line><span style="color:#24292E">  }</span></span>
<span data-line><span style="color:#24292E">}</span></span></code></pre></figure>
<p>其实kernel里面内容并不多。</p>
<h2 id="online-softmax">online softmax<a class="anchor" href="#online-softmax"><span class="icon icon-link"></span></a></h2>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="cpp" data-theme="github-light"><code data-language="cpp" data-theme="github-light" style="display:grid"><span data-line><span style="color:#6A737D">// online softmax</span></span>
<span data-line><span style="color:#6A737D">// FP32</span></span>
<span data-line><span style="color:#6A737D">// DS required for Online Softmax</span></span>
<span data-line><span style="color:#D73A49">struct</span><span style="color:#6F42C1"> __align__</span><span style="color:#24292E">(</span><span style="color:#005CC5">8</span><span style="color:#24292E">) MD {</span></span>
<span data-line><span style="color:#D73A49">  float</span><span style="color:#24292E"> m;</span></span>
<span data-line><span style="color:#D73A49">  float</span><span style="color:#24292E"> d;</span></span>
<span data-line><span style="color:#24292E">};</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">// Warp Reduce for Online Softmax</span></span>
<span data-line><span style="color:#D73A49">template</span><span style="color:#24292E"> &lt;</span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#6F42C1"> kWarpSize</span><span style="color:#D73A49"> =</span><span style="color:#24292E"> WARP_SIZE&gt;</span></span>
<span data-line><span style="color:#24292E">__device__ __forceinline__ MD </span><span style="color:#6F42C1">warp_reduce_md_op</span><span style="color:#24292E">(MD value) {</span></span>
<span data-line><span style="color:#D73A49">  unsigned</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> mask </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">ffffffff</span><span style="color:#24292E">;</span></span>
<span data-line><span style="color:#D73A49">#pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">  for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> stride </span><span style="color:#D73A49">=</span><span style="color:#24292E"> kWarpSize </span><span style="color:#D73A49">&gt;&gt;</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">; stride </span><span style="color:#D73A49">&gt;=</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">; stride </span><span style="color:#D73A49">&gt;&gt;=</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#24292E">    MD other;</span></span>
<span data-line><span style="color:#24292E">    other.m </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> __shfl_xor_sync</span><span style="color:#24292E">(mask, value.m, stride);</span></span>
<span data-line><span style="color:#24292E">    other.d </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> __shfl_xor_sync</span><span style="color:#24292E">(mask, value.d, stride);</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">    bool</span><span style="color:#24292E"> value_bigger </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (value.m </span><span style="color:#D73A49">&gt;</span><span style="color:#24292E"> other.m);</span></span>
<span data-line><span style="color:#24292E">    MD bigger_m </span><span style="color:#D73A49">=</span><span style="color:#24292E"> value_bigger </span><span style="color:#D73A49">?</span><span style="color:#24292E"> value </span><span style="color:#D73A49">:</span><span style="color:#24292E"> other;</span></span>
<span data-line><span style="color:#24292E">    MD smaller_m </span><span style="color:#D73A49">=</span><span style="color:#24292E"> value_bigger </span><span style="color:#D73A49">?</span><span style="color:#24292E"> other </span><span style="color:#D73A49">:</span><span style="color:#24292E"> value;</span></span>
<span data-line> </span>
<span data-line><span style="color:#24292E">    value.d </span><span style="color:#D73A49">=</span><span style="color:#24292E"> bigger_m.d </span><span style="color:#D73A49">+</span><span style="color:#24292E"> smaller_m.d </span><span style="color:#D73A49">*</span><span style="color:#6F42C1"> __expf</span><span style="color:#24292E">(smaller_m.m </span><span style="color:#D73A49">-</span><span style="color:#24292E"> bigger_m.m);</span></span>
<span data-line><span style="color:#24292E">    value.m </span><span style="color:#D73A49">=</span><span style="color:#24292E"> bigger_m.m;</span></span>
<span data-line><span style="color:#24292E">  }</span></span>
<span data-line><span style="color:#D73A49">  return</span><span style="color:#24292E"> value;</span></span>
<span data-line><span style="color:#24292E">}</span></span>
<span data-line> </span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">template</span><span style="color:#24292E"> &lt;</span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> NUM_THREADS </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 256</span><span style="color:#D73A49"> /</span><span style="color:#005CC5"> 4</span><span style="color:#24292E">&gt;</span></span>
<span data-line><span style="color:#24292E">__global__ </span><span style="color:#D73A49">void</span></span>
<span data-line><span style="color:#6F42C1">online_safe_softmax_f32x4_pack_per_token_kernel</span><span style="color:#24292E">(</span><span style="color:#D73A49">float</span><span style="color:#D73A49"> *</span><span style="color:#24292E">x, </span><span style="color:#D73A49">float</span><span style="color:#D73A49"> *</span><span style="color:#24292E">y, </span><span style="color:#D73A49">int</span><span style="color:#24292E"> N) {</span></span>
<span data-line><span style="color:#6A737D">  // reference: https://arxiv.org/pdf/1805.02867 (Online normalizer calculation</span></span>
<span data-line><span style="color:#6A737D">  // for softmax)</span></span>
<span data-line><span style="color:#D73A49">  int</span><span style="color:#24292E"> local_tid </span><span style="color:#D73A49">=</span><span style="color:#24292E"> threadIdx.x;</span></span>
<span data-line><span style="color:#D73A49">  int</span><span style="color:#24292E"> global_tid </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (blockIdx.x </span><span style="color:#D73A49">*</span><span style="color:#24292E"> NUM_THREADS </span><span style="color:#D73A49">+</span><span style="color:#24292E"> local_tid) </span><span style="color:#D73A49">*</span><span style="color:#005CC5"> 4</span><span style="color:#24292E">;</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">  const</span><span style="color:#D73A49"> int</span><span style="color:#24292E"> WARP_NUM </span><span style="color:#D73A49">=</span><span style="color:#24292E"> NUM_THREADS </span><span style="color:#D73A49">/</span><span style="color:#24292E"> WARP_SIZE;</span></span>
<span data-line><span style="color:#D73A49">  int</span><span style="color:#24292E"> warp_id </span><span style="color:#D73A49">=</span><span style="color:#24292E"> local_tid </span><span style="color:#D73A49">/</span><span style="color:#24292E"> WARP_SIZE;</span></span>
<span data-line><span style="color:#D73A49">  int</span><span style="color:#24292E"> lane_id </span><span style="color:#D73A49">=</span><span style="color:#24292E"> local_tid </span><span style="color:#D73A49">%</span><span style="color:#24292E"> WARP_SIZE;</span></span>
<span data-line><span style="color:#6A737D">  // compare local max value</span></span>
<span data-line><span style="color:#24292E">  float4 val </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> FLOAT4</span><span style="color:#24292E">((x)[global_tid]);</span></span>
<span data-line><span style="color:#D73A49">  float</span><span style="color:#24292E"> local_m </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> fmaxf</span><span style="color:#24292E">(</span><span style="color:#6F42C1">fmaxf</span><span style="color:#24292E">(val.x, val.y), </span><span style="color:#6F42C1">fmaxf</span><span style="color:#24292E">(val.z, val.w));</span></span>
<span data-line><span style="color:#D73A49">  float</span><span style="color:#24292E"> local_d </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> __expf</span><span style="color:#24292E">(val.x </span><span style="color:#D73A49">-</span><span style="color:#24292E"> local_m) </span><span style="color:#D73A49">+</span><span style="color:#6F42C1"> __expf</span><span style="color:#24292E">(val.y </span><span style="color:#D73A49">-</span><span style="color:#24292E"> local_m) </span><span style="color:#D73A49">+</span></span>
<span data-line><span style="color:#6F42C1">                  __expf</span><span style="color:#24292E">(val.z </span><span style="color:#D73A49">-</span><span style="color:#24292E"> local_m) </span><span style="color:#D73A49">+</span><span style="color:#6F42C1"> __expf</span><span style="color:#24292E">(val.w </span><span style="color:#D73A49">-</span><span style="color:#24292E"> local_m);</span></span>
<span data-line> </span>
<span data-line><span style="color:#24292E">  MD local_md </span><span style="color:#D73A49">=</span><span style="color:#24292E"> {local_m, local_d};</span></span>
<span data-line><span style="color:#24292E">  MD res </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> warp_reduce_md_op</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">WARP_SIZE</span><span style="color:#24292E">&gt;(local_md);</span></span>
<span data-line><span style="color:#24292E">  __shared__ MD shared[WARP_NUM];</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">  if</span><span style="color:#24292E"> (lane_id </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">)</span></span>
<span data-line><span style="color:#24292E">    shared[warp_id] </span><span style="color:#D73A49">=</span><span style="color:#24292E"> res;</span></span>
<span data-line><span style="color:#6F42C1">  __syncthreads</span><span style="color:#24292E">();</span></span>
<span data-line><span style="color:#6A737D">  // do block reduce</span></span>
<span data-line><span style="color:#D73A49">  if</span><span style="color:#24292E"> (local_tid </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> WARP_SIZE) {</span></span>
<span data-line><span style="color:#24292E">    MD block_res </span><span style="color:#D73A49">=</span><span style="color:#24292E"> shared[local_tid];</span></span>
<span data-line><span style="color:#24292E">    block_res </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> warp_reduce_md_op</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">WARP_NUM</span><span style="color:#24292E">&gt;(block_res);</span></span>
<span data-line><span style="color:#D73A49">    if</span><span style="color:#24292E"> (local_tid </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">)</span></span>
<span data-line><span style="color:#24292E">      shared[</span><span style="color:#005CC5">0</span><span style="color:#24292E">] </span><span style="color:#D73A49">=</span><span style="color:#24292E"> block_res;</span></span>
<span data-line><span style="color:#24292E">  }</span></span>
<span data-line><span style="color:#6F42C1">  __syncthreads</span><span style="color:#24292E">();</span></span>
<span data-line><span style="color:#6A737D">  // write back</span></span>
<span data-line><span style="color:#24292E">  MD final_res </span><span style="color:#D73A49">=</span><span style="color:#24292E"> shared[</span><span style="color:#005CC5">0</span><span style="color:#24292E">];</span></span>
<span data-line><span style="color:#D73A49">  float</span><span style="color:#24292E"> d_total_inverse </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> __fdividef</span><span style="color:#24292E">(</span><span style="color:#005CC5">1.0</span><span style="color:#D73A49">f</span><span style="color:#24292E">, final_res.d);</span></span>
<span data-line><span style="color:#D73A49">  if</span><span style="color:#24292E"> (global_tid </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> N) {</span></span>
<span data-line><span style="color:#24292E">    float4 reg_y;</span></span>
<span data-line><span style="color:#24292E">    reg_y.x </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> __expf</span><span style="color:#24292E">(val.x </span><span style="color:#D73A49">-</span><span style="color:#24292E"> final_res.m) </span><span style="color:#D73A49">*</span><span style="color:#24292E"> d_total_inverse;</span></span>
<span data-line><span style="color:#24292E">    reg_y.y </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> __expf</span><span style="color:#24292E">(val.y </span><span style="color:#D73A49">-</span><span style="color:#24292E"> final_res.m) </span><span style="color:#D73A49">*</span><span style="color:#24292E"> d_total_inverse;</span></span>
<span data-line><span style="color:#24292E">    reg_y.z </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> __expf</span><span style="color:#24292E">(val.z </span><span style="color:#D73A49">-</span><span style="color:#24292E"> final_res.m) </span><span style="color:#D73A49">*</span><span style="color:#24292E"> d_total_inverse;</span></span>
<span data-line><span style="color:#24292E">    reg_y.w </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> __expf</span><span style="color:#24292E">(val.w </span><span style="color:#D73A49">-</span><span style="color:#24292E"> final_res.m) </span><span style="color:#D73A49">*</span><span style="color:#24292E"> d_total_inverse;</span></span>
<span data-line><span style="color:#6F42C1">    FLOAT4</span><span style="color:#24292E">((y)[global_tid]) </span><span style="color:#D73A49">=</span><span style="color:#24292E"> reg_y;</span></span>
<span data-line><span style="color:#24292E">  }</span></span>
<span data-line><span style="color:#24292E">}</span></span></code></pre></figure>
<h1 id="sgemv">sgemv<a class="anchor" href="#sgemv"><span class="icon icon-link"></span></a></h1>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="cpp" data-theme="github-light"><code data-language="cpp" data-theme="github-light" style="display:grid"><span data-line><span style="color:#D73A49">template</span><span style="color:#24292E"> &lt;</span><span style="color:#D73A49">const</span><span style="color:#D73A49"> int</span><span style="color:#6F42C1"> kWarpSize</span><span style="color:#D73A49"> =</span><span style="color:#24292E"> WARP_SIZE&gt;</span></span>
<span data-line><span style="color:#24292E">__device__ __forceinline__ </span><span style="color:#D73A49">float</span><span style="color:#6F42C1"> warp_reduce_sum_f32</span><span style="color:#24292E">(</span><span style="color:#D73A49">float</span><span style="color:#24292E"> val) {</span></span>
<span data-line><span style="color:#D73A49">#pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">  for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> mask </span><span style="color:#D73A49">=</span><span style="color:#24292E"> kWarpSize </span><span style="color:#D73A49">&gt;&gt;</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">; mask </span><span style="color:#D73A49">&gt;=</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">; mask </span><span style="color:#D73A49">&gt;&gt;=</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">) {</span></span>
<span data-line><span style="color:#24292E">    val </span><span style="color:#D73A49">+=</span><span style="color:#6F42C1"> __shfl_xor_sync</span><span style="color:#24292E">(</span><span style="color:#D73A49">0x</span><span style="color:#005CC5">ffffffff</span><span style="color:#24292E">, val, mask);</span></span>
<span data-line><span style="color:#24292E">  }</span></span>
<span data-line><span style="color:#D73A49">  return</span><span style="color:#24292E"> val;</span></span>
<span data-line><span style="color:#24292E">}</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">// SGEMV: Warp SGEMV K128 + Vec4</span></span>
<span data-line><span style="color:#6A737D">// 假设K为128的倍数 float4</span></span>
<span data-line><span style="color:#6A737D">// grid(M/4), block(32,4) blockDim.x=32=K, blockDim.y=4</span></span>
<span data-line><span style="color:#6A737D">// a: MxK, x: Kx1, y: Mx1, compute: y = a * x</span></span>
<span data-line><span style="color:#24292E">__global__ </span><span style="color:#D73A49">void</span><span style="color:#6F42C1"> sgemv_k128_f32x4_kernel</span><span style="color:#24292E">(</span><span style="color:#D73A49">float</span><span style="color:#D73A49"> *</span><span style="color:#24292E">a, </span><span style="color:#D73A49">float</span><span style="color:#D73A49"> *</span><span style="color:#24292E">x, </span><span style="color:#D73A49">float</span><span style="color:#D73A49"> *</span><span style="color:#24292E">y, </span><span style="color:#D73A49">int</span><span style="color:#24292E"> M,</span></span>
<span data-line><span style="color:#D73A49">                                        int</span><span style="color:#24292E"> K) {</span></span>
<span data-line><span style="color:#6A737D">  // 每个线程负责4个元素，一个warp覆盖128个元素</span></span>
<span data-line><span style="color:#D73A49">  int</span><span style="color:#24292E"> tx </span><span style="color:#D73A49">=</span><span style="color:#24292E"> threadIdx.x;</span><span style="color:#6A737D">         // 0~31</span></span>
<span data-line><span style="color:#D73A49">  int</span><span style="color:#24292E"> ty </span><span style="color:#D73A49">=</span><span style="color:#24292E"> threadIdx.y;</span><span style="color:#6A737D">         // 0~3</span></span>
<span data-line><span style="color:#D73A49">  int</span><span style="color:#24292E"> bx </span><span style="color:#D73A49">=</span><span style="color:#24292E"> blockIdx.x;</span><span style="color:#6A737D">          // 0~M/4</span></span>
<span data-line><span style="color:#D73A49">  int</span><span style="color:#24292E"> lane </span><span style="color:#D73A49">=</span><span style="color:#24292E"> tx </span><span style="color:#D73A49">%</span><span style="color:#24292E"> WARP_SIZE;</span><span style="color:#6A737D">    // 0~31</span></span>
<span data-line><span style="color:#D73A49">  int</span><span style="color:#24292E"> m </span><span style="color:#D73A49">=</span><span style="color:#24292E"> blockDim.y </span><span style="color:#D73A49">*</span><span style="color:#24292E"> bx </span><span style="color:#D73A49">+</span><span style="color:#24292E"> ty;</span><span style="color:#6A737D"> // (0~M/4) * 4 + (0~3)</span></span>
<span data-line> </span>
<span data-line><span style="color:#D73A49">  if</span><span style="color:#24292E"> (m </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> M) {</span></span>
<span data-line><span style="color:#D73A49">    float</span><span style="color:#24292E"> sum </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0.0</span><span style="color:#D73A49">f</span><span style="color:#24292E">;</span></span>
<span data-line><span style="color:#6A737D">    // process 4*WARP_SIZE elements per warp.</span></span>
<span data-line><span style="color:#D73A49">    int</span><span style="color:#24292E"> NUM_WARPS </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (((K </span><span style="color:#D73A49">+</span><span style="color:#24292E"> WARP_SIZE </span><span style="color:#D73A49">-</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">) </span><span style="color:#D73A49">/</span><span style="color:#24292E"> WARP_SIZE) </span><span style="color:#D73A49">+</span><span style="color:#005CC5"> 4</span><span style="color:#D73A49"> -</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">) </span><span style="color:#D73A49">/</span><span style="color:#005CC5"> 4</span><span style="color:#24292E">;</span></span>
<span data-line><span style="color:#D73A49">#pragma</span><span style="color:#6F42C1"> unroll</span></span>
<span data-line><span style="color:#D73A49">    for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">int</span><span style="color:#24292E"> w </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; w </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> NUM_WARPS; </span><span style="color:#D73A49">++</span><span style="color:#24292E">w) {</span></span>
<span data-line><span style="color:#D73A49">      int</span><span style="color:#24292E"> k </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (w </span><span style="color:#D73A49">*</span><span style="color:#24292E"> WARP_SIZE </span><span style="color:#D73A49">+</span><span style="color:#24292E"> lane) </span><span style="color:#D73A49">*</span><span style="color:#005CC5"> 4</span><span style="color:#24292E">;</span></span>
<span data-line><span style="color:#24292E">      float4 reg_x </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> FLOAT4</span><span style="color:#24292E">(x[k]);</span></span>
<span data-line><span style="color:#24292E">      float4 reg_a </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> FLOAT4</span><span style="color:#24292E">(a[m </span><span style="color:#D73A49">*</span><span style="color:#24292E"> K </span><span style="color:#D73A49">+</span><span style="color:#24292E"> k]);</span></span>
<span data-line><span style="color:#24292E">      sum </span><span style="color:#D73A49">+=</span><span style="color:#24292E"> (reg_a.x </span><span style="color:#D73A49">*</span><span style="color:#24292E"> reg_x.x </span><span style="color:#D73A49">+</span><span style="color:#24292E"> reg_a.y </span><span style="color:#D73A49">*</span><span style="color:#24292E"> reg_x.y </span><span style="color:#D73A49">+</span><span style="color:#24292E"> reg_a.z </span><span style="color:#D73A49">*</span><span style="color:#24292E"> reg_x.z </span><span style="color:#D73A49">+</span></span>
<span data-line><span style="color:#24292E">              reg_a.w </span><span style="color:#D73A49">*</span><span style="color:#24292E"> reg_x.w);</span></span>
<span data-line><span style="color:#24292E">    }</span></span>
<span data-line><span style="color:#24292E">    sum </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> warp_reduce_sum_f32</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">WARP_SIZE</span><span style="color:#24292E">&gt;(sum);</span></span>
<span data-line><span style="color:#D73A49">    if</span><span style="color:#24292E"> (lane </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">)</span></span>
<span data-line><span style="color:#24292E">      y[m] </span><span style="color:#D73A49">=</span><span style="color:#24292E"> sum;</span></span>
<span data-line><span style="color:#24292E">  }</span></span>
<span data-line><span style="color:#24292E">}</span></span></code></pre></figure>
<h1 id="element-wise">element-wise<a class="anchor" href="#element-wise"><span class="icon icon-link"></span></a></h1>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="cpp" data-theme="github-light"><code data-language="cpp" data-theme="github-light" style="display:grid"><span data-line><span style="color:#D73A49">#define</span><span style="color:#6F42C1"> FLOAT4</span><span style="color:#24292E">(</span><span style="color:#E36209">value</span><span style="color:#24292E">) (</span><span style="color:#D73A49">reinterpret_cast&lt;</span><span style="color:#24292E">float4</span><span style="color:#D73A49">*&gt;</span><span style="color:#24292E">(</span><span style="color:#D73A49">&amp;</span><span style="color:#24292E">(value))[</span><span style="color:#005CC5">0</span><span style="color:#24292E">])</span></span>
<span data-line> </span>
<span data-line><span style="color:#6A737D">// ElementWise Add + Vec4</span></span>
<span data-line><span style="color:#6A737D">// grid(N/256), block(256/4)</span></span>
<span data-line><span style="color:#6A737D">// a: Nx1, b: Nx1, c: Nx1, c = elementwise_add(a, b)</span></span>
<span data-line><span style="color:#24292E">__global__ </span><span style="color:#D73A49">void</span><span style="color:#6F42C1"> elementwise_add_f32x4_kernel</span><span style="color:#24292E">(</span><span style="color:#D73A49">float</span><span style="color:#D73A49"> *</span><span style="color:#24292E">a, </span><span style="color:#D73A49">float</span><span style="color:#D73A49"> *</span><span style="color:#24292E">b, </span><span style="color:#D73A49">float</span><span style="color:#D73A49"> *</span><span style="color:#24292E">c,</span></span>
<span data-line><span style="color:#D73A49">                                             int</span><span style="color:#24292E"> N) {</span></span>
<span data-line><span style="color:#D73A49">  int</span><span style="color:#24292E"> idx </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 4</span><span style="color:#D73A49"> *</span><span style="color:#24292E"> (blockIdx.x </span><span style="color:#D73A49">*</span><span style="color:#24292E"> blockDim.x </span><span style="color:#D73A49">+</span><span style="color:#24292E"> threadIdx.x);</span></span>
<span data-line><span style="color:#D73A49">  if</span><span style="color:#24292E"> (idx </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> N) {</span></span>
<span data-line><span style="color:#24292E">    float4 reg_a </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> FLOAT4</span><span style="color:#24292E">(a[idx]);</span></span>
<span data-line><span style="color:#24292E">    float4 reg_b </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> FLOAT4</span><span style="color:#24292E">(b[idx]);</span></span>
<span data-line><span style="color:#24292E">    float4 reg_c;</span></span>
<span data-line><span style="color:#24292E">    reg_c.x </span><span style="color:#D73A49">=</span><span style="color:#24292E"> reg_a.x </span><span style="color:#D73A49">+</span><span style="color:#24292E"> reg_b.x;</span></span>
<span data-line><span style="color:#24292E">    reg_c.y </span><span style="color:#D73A49">=</span><span style="color:#24292E"> reg_a.y </span><span style="color:#D73A49">+</span><span style="color:#24292E"> reg_b.y;</span></span>
<span data-line><span style="color:#24292E">    reg_c.z </span><span style="color:#D73A49">=</span><span style="color:#24292E"> reg_a.z </span><span style="color:#D73A49">+</span><span style="color:#24292E"> reg_b.z;</span></span>
<span data-line><span style="color:#24292E">    reg_c.w </span><span style="color:#D73A49">=</span><span style="color:#24292E"> reg_a.w </span><span style="color:#D73A49">+</span><span style="color:#24292E"> reg_b.w;</span></span>
<span data-line><span style="color:#6F42C1">    FLOAT4</span><span style="color:#24292E">(c[idx]) </span><span style="color:#D73A49">=</span><span style="color:#24292E"> reg_c;</span></span>
<span data-line><span style="color:#24292E">  }</span></span>
<span data-line><span style="color:#24292E">}</span></span></code></pre></figure>  </article> </div> </div> <section class="mt-12" aria-label="Comments"> <script src="https://utteranc.es/client.js" repo="l1cacheDell/l1cacheDell.github.io" issue-term="title" * 'pathname' | 'title' | 任意字符串键 * label="comment" theme="github-light" crossorigin="anonymous" async></script> <noscript>请启用 JavaScript 以查看评论（Utterances）。</noscript> </section>  <footer class="border-t"> <div class="mx-auto max-w-5xl px-4 py-8 text-center text-sm text-slate-500">
© 2021-2025 L1 Cached Papers: Only the Papers That Matter — HPC, LLM Inference, Crypto.
</div> </footer> </body></html>